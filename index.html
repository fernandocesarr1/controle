<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Orçamentário Familiar</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* Estilos personalizados e animações */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f8fafc; /* Fundo cinza claro */
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .float-animation {
            animation: float 4s ease-in-out infinite;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        // Configuração do Firebase (use suas chaves reais aqui)
        const firebaseConfig = {
            apiKey: "AIzaSyAgopSuSjeQ26UL85eYb11w4BbbNtBg5QE",
            authDomain: "orcamento-familiar-dc2e6.firebaseapp.com",
            databaseURL: "https://orcamento-familiar-dc2e6-default-rtdb.firebaseio.com",
            projectId: "orcamento-familiar-dc2e6",
            storageBucket: "orcamento-familiar-dc2e6.firebasestorage.app",
            messagingSenderId: "21809188621",
            appId: "1:21809188621:web:103d45c3353106ebf5aa44",
            measurementId: "G-4E95DZRK3F"
        };

        // Inicializar Firebase
        let database;
        let isFirebaseInitialized = false;

        try {
            if (firebaseConfig.apiKey && !firebaseConfig.apiKey.includes("SUA_API_KEY")) {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                isFirebaseInitialized = true;
            } else {
                 console.warn("Configuração do Firebase não preenchida. O app funcionará em modo offline.");
            }
        } catch (error) {
            console.error("Erro ao inicializar Firebase:", error);
        }
        
        function getTodayDateString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Meses são 0-indexados
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Estado da aplicação
        let state = {
            isAuthenticated: false,
            showLogin: true,
            showChangePassword: false,
            loginPassword: '',
            newPassword: '',
            confirmPassword: '',
            loginError: '',
            passwordError: '',
            activeTab: 'adicionar',
            categoriasFixas: ['Escola', 'Diarista', 'Internet', 'Água', 'Luz', 'Clube'],
            categoriasVariaveis: ['Supermercado', 'Farmácia', 'Lazer'],
            limites: {},
            gastos: [],
            notificacoes: [],
            nomes: ['Fernando', 'Estefania'],
            limiteMensal: 0,
            limitesPorPessoa: {},
            showAddCategory: false,
            showEditNames: false,
            showEditGasto: false,
            showNotificationsReport: false,
            editingGastoId: null,
            searchQuery: '',
            searchResults: [],
            showMenu: false,
            selectedYear: new Date().getFullYear(),
            selectedMonth: new Date().getMonth(),
            selectedMonthGrafico: new Date().getMonth(),
            dashboardYear: new Date().getFullYear(),
            dashboardMonth: new Date().getMonth(),
            formData: {
                tipo: 'variavel',
                categoria: '',
                valor: '',
                data: getTodayDateString(),
                descricao: '',
                responsavel: ''
            },
            tempNome1: 'Fernando',
            tempNome2: 'Estefania',
            newCategoryName: '',
            categoryType: 'fixo',
            charts: {}
        };

        const DEFAULT_PASSWORD = 'familia2024';
        
        function logAction(actionType, gastoData) {
            if (!isFirebaseInitialized) return;
            const logEntry = {
                action: actionType, // 'criação', 'edição', 'exclusão'
                timestamp: new Date().toISOString(),
                gasto: gastoData
            };
            database.ref('notificacoes').push(logEntry);
        }

        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }

        function checkStoredPassword() {
            if (!isFirebaseInitialized) return;
            database.ref('auth/passwordHash').once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    database.ref('auth/passwordHash').set(simpleHash(DEFAULT_PASSWORD));
                }
            });
        }

        function handleLogin() {
            if (!state.loginPassword) {
                state.loginError = 'Por favor, digite a senha.';
                render();
                return;
            }

            if (!isFirebaseInitialized) {
                state.loginError = 'Firebase não está configurado corretamente.';
                render();
                return;
            }

            const passwordHash = simpleHash(state.loginPassword);
            
            database.ref('auth/passwordHash').once('value', (snapshot) => {
                const storedHash = snapshot.val();
                
                if (storedHash === passwordHash) {
                    state.isAuthenticated = true;
                    state.showLogin = false;
                    state.loginError = '';
                    state.loginPassword = '';
                    loadFromFirebase();
                    render();
                } else {
                    state.loginError = 'Senha incorreta. Tente novamente.';
                    render();
                }
            });
        }
        
        function handleChangePassword() {
            if (!state.newPassword || !state.confirmPassword) {
                state.passwordError = 'Preencha todos os campos';
                render();
                return;
            }

            if (state.newPassword.length < 6) {
                state.passwordError = 'A senha deve ter pelo menos 6 caracteres';
                render();
                return;
            }

            if (state.newPassword !== state.confirmPassword) {
                state.passwordError = 'As senhas não coincidem';
                render();
                return;
            }

            const newPasswordHash = simpleHash(state.newPassword);
            database.ref('auth/passwordHash').set(newPasswordHash);
            
            state.showChangePassword = false;
            state.newPassword = '';
            state.confirmPassword = '';
            state.passwordError = '';
            alert('Senha alterada com sucesso! ✅');
            render();
        }

        function handleLogout() {
            state.isAuthenticated = false;
            state.showLogin = true;
            state.activeTab = 'dashboard';
            render();
        }

        function syncWithFirebase() {
            if (!isFirebaseInitialized) return;
            database.ref('appData').set({
                categorias: {
                    fixas: state.categoriasFixas,
                    variaveis: state.categoriasVariaveis
                },
                limites: state.limites,
                nomes: state.nomes,
                limiteMensal: state.limiteMensal || 0,
                limitesPorPessoa: state.limitesPorPessoa || {}
            });
        }

        function saveGastoToFirebase(gasto) {
            if (!isFirebaseInitialized) return;
            database.ref('gastos/' + gasto.id).set(gasto);
        }

        function removeGastoFromFirebase(id) {
            if (!isFirebaseInitialized) return;
            database.ref('gastos/' + id).remove();
        }

        function loadFromFirebase() {
            if (!isFirebaseInitialized) return;

            database.ref('appData').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    state.categoriasFixas = data.categorias?.fixas || state.categoriasFixas;
                    state.categoriasVariaveis = data.categorias?.variaveis || state.categoriasVariaveis;
                    state.limites = data.limites || state.limites;
                    state.nomes = data.nomes || state.nomes;
                    state.limiteMensal = data.limiteMensal || 0;
                    state.limitesPorPessoa = data.limitesPorPessoa || {};
                    state.formData.responsavel = '';
                    render();
                }
            });

            database.ref('gastos').on('value', (snapshot) => {
                const data = snapshot.val();
                state.gastos = data ? Object.values(data) : [];
                render();
            });
            
            database.ref('notificacoes').on('value', (snapshot) => {
                const data = snapshot.val();
                state.notificacoes = data ? Object.values(data) : [];
                if (state.showNotificationsReport) {
                    render();
                }
            });
        }

        function calcularTotalCategoria(categoria, tipo) {
            return state.gastos
                .filter(g => {
                    const dataGasto = new Date(g.data + 'T00:00:00');
                    return g.categoria === categoria && 
                        g.tipo === tipo && 
                        dataGasto.getMonth() === state.dashboardMonth && 
                        dataGasto.getFullYear() === state.dashboardYear;
                })
                .reduce((sum, g) => sum + g.valor, 0);
        }

        function calcularTotalPorPessoa(pessoa) {
            return state.gastos
                .filter(g => {
                    const dataGasto = new Date(g.data + 'T00:00:00');
                    return g.responsavel === pessoa && 
                        dataGasto.getMonth() === state.dashboardMonth && 
                        dataGasto.getFullYear() === state.dashboardYear;
                })
                .reduce((sum, g) => sum + g.valor, 0);
        }
        
        function calcularSaldoAnual() {
            const gastosDoAno = state.gastos.filter(g => {
                const dataGasto = new Date(g.data + 'T00:00:00');
                return dataGasto.getFullYear() === state.dashboardYear;
            });

            const totalPessoa1 = gastosDoAno
                .filter(g => g.responsavel === state.nomes[0])
                .reduce((sum, g) => sum + g.valor, 0);

            const totalPessoa2 = gastosDoAno
                .filter(g => g.responsavel === state.nomes[1])
                .reduce((sum, g) => sum + g.valor, 0);
            
            return totalPessoa1 - totalPessoa2; 
        }

        function updateDashboardDate(mes, ano) {
            state.dashboardMonth = parseInt(mes);
            state.dashboardYear = parseInt(ano);
            setTimeout(() => render(), 0);
        }

        function getAnosDashboard() {
            const anos = new Set(state.gastos.map(g => new Date(g.data + 'T00:00:00').getFullYear()));
            if (anos.size === 0) {
                anos.add(new Date().getFullYear());
            }
            return Array.from(anos).sort((a, b) => b - a);
        }
        
        function verificarLimite(categoria, total) {
            const limite = state.limites[categoria];
            if (!limite || limite <= 0) return 'safe';
            const percentual = (total / limite) * 100;
            if (percentual > 100) return 'danger';
            if (percentual >= 80) return 'warning';
            return 'safe';
        }

        function handleAddCategory() {
            if (state.newCategoryName.trim()) {
                const list = state.categoryType === 'fixo' ? state.categoriasFixas : state.categoriasVariaveis;
                if (!list.includes(state.newCategoryName.trim())) {
                    list.push(state.newCategoryName.trim());
                    syncWithFirebase();
                }
                state.newCategoryName = '';
                state.showAddCategory = false;
                render();
            }
        }

        

        function openAddCategory() {
            state.showAddCategory = true;
            render();
        }

        function handleEditCategory(type, oldName) {
            const list = type === 'fixo' ? state.categoriasFixas : state.categoriasVariaveis;
            const idx = list.indexOf(oldName);
            if (idx === -1) return;
            const novo = prompt('Digite o novo nome para a categoria:', oldName);
            if (novo && novo.trim()) {
                // evitar nomes duplicados
                if (list.includes(novo.trim())) {
                    alert('Já existe uma categoria com esse nome.');
                    return;
                }
                list[idx] = novo.trim();
                syncWithFirebase();
                render();
            }
        }

        function handleDeleteCategory(type, name) {
            if (!confirm('Tem certeza que deseja excluir a categoria \"' + name + '\"? Isso não excluirá os lançamentos existentes, apenas a categoria.')) return;
            const list = type === 'fixo' ? state.categoriasFixas : state.categoriasVariaveis;
            state.categoriasFixas = state.categoriasFixas.filter(c => c !== name);
            state.categoriasVariaveis = state.categoriasVariaveis.filter(c => c !== name);
            syncWithFirebase();
            render();
        }
        function handleAddGasto() {
            if (state.formData.valor > 0 && state.formData.data && state.formData.descricao.trim() && state.formData.responsavel) {
                const novoGasto = {
                    id: Date.now(),
                    ...state.formData,
                    valor: parseFloat(state.formData.valor)
                };
                state.gastos.push(novoGasto);
                saveGastoToFirebase(novoGasto);
                logAction('criação', novoGasto);
                
                state.formData = {
                    tipo: 'variavel',
                    categoria: '',
                    valor: '',
                    data: getTodayDateString(),
                    descricao: '',
                    responsavel: ''
                };
                alert('Gasto adicionado com sucesso! 🎉');
                changeTab('dashboard');
            } else {
                alert('⚠️ Por favor, preencha Valor, Data, Descrição e Responsável para adicionar um gasto.');
            }
        }

        function handleClearForm() {
            state.formData = {
                tipo: 'variavel',
                categoria: '',
                valor: '',
                data: getTodayDateString(),
                descricao: '',
                responsavel: ''
            };
            render();
        }

        function handleSearch() {
            if (!state.searchQuery.trim()) {
                state.searchResults = [];
                render();
                return;
            }

            const query = state.searchQuery.toLowerCase().trim();
            
            state.searchResults = state.gastos.filter(gasto => {
                const categoria = gasto.categoria.toLowerCase();
                const descricao = (gasto.descricao || '').toLowerCase();
                const responsavel = gasto.responsavel.toLowerCase();
                const valor = gasto.valor.toString();
                const data = new Date(gasto.data + 'T00:00:00').toLocaleDateString('pt-BR');
                const tipo = gasto.tipo === 'fixo' ? 'fixo' : 'variável';
                
                return categoria.includes(query) ||
                       descricao.includes(query) ||
                       responsavel.includes(query) ||
                       valor.includes(query) ||
                       data.includes(query) ||
                       tipo.includes(query);
            }).sort((a, b) => new Date(b.data) - new Date(a.data));
            
            render();
        }

        function clearSearch() {
            state.searchQuery = '';
            state.searchResults = [];
            render();
        }

        function handleRemoveGasto(id) {
            if (confirm('Tem certeza que deseja excluir este gasto?')) {
                const gastoParaExcluir = state.gastos.find(g => g.id === id);
                if (gastoParaExcluir) {
                    logAction('exclusão', gastoParaExcluir);
                }
                state.gastos = state.gastos.filter(g => g.id !== id);
                removeGastoFromFirebase(id);
                render();
            }
        }

        function openEditGasto(id) {
            const gasto = state.gastos.find(g => g.id === id);
            if (gasto) {
                state.editingGastoId = id;
                state.formData = {
                    tipo: gasto.tipo,
                    categoria: gasto.categoria,
                    valor: gasto.valor,
                    data: gasto.data,
                    descricao: gasto.descricao || '',
                    responsavel: gasto.responsavel
                };
                state.showEditGasto = true;
                render();
            }
        }

        function handleSaveEditGasto() {
            if (state.formData.valor > 0 && state.formData.data && state.formData.descricao.trim() && state.formData.responsavel) {
                const index = state.gastos.findIndex(g => g.id === state.editingGastoId);
                if (index !== -1) {
                    state.gastos[index] = {
                        id: state.editingGastoId,
                        ...state.formData,
                        valor: parseFloat(state.formData.valor)
                    };
                    const gastoEditado = state.gastos[index];
                    saveGastoToFirebase(gastoEditado);
                    logAction('edição', gastoEditado);
                    
                    state.showEditGasto = false;
                    state.editingGastoId = null;
                    state.formData = {
                        tipo: 'variavel',
                        categoria: '',
                        valor: '',
                        data: getTodayDateString(),
                        descricao: '',
                        responsavel: ''
                    };
                    alert('Gasto atualizado com sucesso! ✅');
                    render();
                }
            } else {
                alert('⚠️ Por favor, preencha Valor, Data, Descrição e Responsável para salvar o gasto.');
            }
        }

        function cancelEditGasto() {
            state.showEditGasto = false;
            state.editingGastoId = null;
            state.formData = {
                tipo: 'variavel',
                categoria: '',
                valor: '',
                data: getTodayDateString(),
                descricao: '',
                responsavel: ''
            };
            render();
        }

        function handleSetLimite(categoria, valor) {
            state.limites[categoria] = parseFloat(valor) || 0;
            syncWithFirebase();
        }

        function handleSaveNames() {
            state.nomes = [state.tempNome1.trim(), state.tempNome2.trim()];
            state.formData.responsavel = state.nomes[0];
            syncWithFirebase();
            state.showEditNames = false;
            render();
        }

        function exportToExcel() {
            if (state.gastos.length === 0) {
                alert('⚠️ Não há gastos para exportar!');
                return;
            }

            const dadosExportacao = state.gastos.map(gasto => ({
                'Data': new Date(gasto.data + 'T00:00:00').toLocaleDateString('pt-BR'),
                'Tipo': gasto.tipo === 'fixo' ? 'Fixo' : 'Variável',
                'Categoria': gasto.categoria,
                'Responsável': gasto.responsavel,
                'Valor (R$)': gasto.valor.toFixed(2),
                'Descrição': gasto.descricao || '-'
            }));

            dadosExportacao.sort((a, b) => {
                const dataA = a['Data'].split('/').reverse().join('');
                const dataB = b['Data'].split('/').reverse().join('');
                return dataB.localeCompare(dataA);
            });
            
            const ws = XLSX.utils.json_to_sheet(dadosExportacao);
            ws['!cols'] = [ { wch: 12 }, { wch: 10 }, { wch: 20 }, { wch: 15 }, { wch: 12 }, { wch: 40 } ];
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Gastos');
            const nomeArquivo = `Orcamento_Familiar_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.xlsx`;
            XLSX.writeFile(wb, nomeArquivo);
            alert('✅ Planilha exportada com sucesso!');
        }

        function exportToPDF() {
            if (state.gastos.length === 0) {
                alert('⚠️ Não há gastos para exportar!');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Título
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('Controle Orçamentário Familiar', 14, 20);
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, 14, 28);

            // Preparar dados
            const dadosExportacao = state.gastos.map(gasto => [
                new Date(gasto.data + 'T00:00:00').toLocaleDateString('pt-BR'),
                gasto.tipo === 'fixo' ? 'Fixo' : 'Variável',
                gasto.categoria,
                gasto.responsavel,
                `R$ ${gasto.valor.toFixed(2)}`,
                gasto.descricao || '-'
            ]);

            // Ordenar por data (mais recente primeiro)
            dadosExportacao.sort((a, b) => {
                const dataA = a[0].split('/').reverse().join('');
                const dataB = b[0].split('/').reverse().join('');
                return dataB.localeCompare(dataA);
            });

            // Criar tabela
            doc.autoTable({
                startY: 35,
                head: [['Data', 'Tipo', 'Categoria', 'Responsável', 'Valor', 'Descrição']],
                body: dadosExportacao,
                theme: 'striped',
                headStyles: { fillColor: [59, 130, 246], fontSize: 10, fontStyle: 'bold' },
                styles: { fontSize: 9, cellPadding: 3 },
                columnStyles: {
                    0: { cellWidth: 25 },
                    1: { cellWidth: 20 },
                    2: { cellWidth: 30 },
                    3: { cellWidth: 30 },
                    4: { cellWidth: 25, halign: 'right' },
                    5: { cellWidth: 'auto' }
                }
            });

            // Salvar
            const nomeArquivo = `Orcamento_Familiar_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.pdf`;
            doc.save(nomeArquivo);
            alert('✅ PDF exportado com sucesso!');
        }

        function getTotals() {
            const gastosDoMes = state.gastos.filter(g => {
                const dataGasto = new Date(g.data + 'T00:00:00');
                return dataGasto.getMonth() === state.dashboardMonth && 
                    dataGasto.getFullYear() === state.dashboardYear;
            });
            
            const gastosDoAno = state.gastos.filter(g => {
                const dataGasto = new Date(g.data + 'T00:00:00');
                return dataGasto.getFullYear() === state.dashboardYear;
            });
            
            const totalFixos = gastosDoMes.filter(g => g.tipo === 'fixo').reduce((sum, g) => sum + g.valor, 0);
            const totalVariaveis = gastosDoMes.filter(g => g.tipo === 'variavel').reduce((sum, g) => sum + g.valor, 0);
            const totalMes = totalFixos + totalVariaveis;
            const totalAno = gastosDoAno.reduce((sum, g) => sum + g.valor, 0);
            
            return { totalFixos, totalVariaveis, totalGeral: totalMes, totalAno };
        }
        
        function processarDadosMensais(ano) {
            const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            const dados = {
                labels: meses,
                total: Array(12).fill(0),
                pessoa1: Array(12).fill(0),
                pessoa2: Array(12).fill(0)
            };
            state.gastos.forEach(gasto => {
                const dataGasto = new Date(gasto.data + 'T00:00:00');
                if (dataGasto.getFullYear() === ano) {
                    const mes = dataGasto.getMonth();
                    dados.total[mes] += gasto.valor;
                    if (gasto.responsavel === state.nomes[0]) {
                        dados.pessoa1[mes] += gasto.valor;
                    } else if (gasto.responsavel === state.nomes[1]) {
                        dados.pessoa2[mes] += gasto.valor;
                    }
                }
            });
            return dados;
        }

        function processarDadosPorMes(mes, ano) {
            const todasCategorias = [...state.categoriasFixas, ...state.categoriasVariaveis].sort();
            const dados = {};
            
            todasCategorias.forEach(cat => {
                dados[cat] = 0;
            });
            
            state.gastos.forEach(gasto => {
                const dataGasto = new Date(gasto.data + 'T00:00:00');
                if (dataGasto.getFullYear() === ano && dataGasto.getMonth() === mes) {
                    if (dados[gasto.categoria] !== undefined) {
                        dados[gasto.categoria] += gasto.valor;
                    }
                }
            });
            
            return {
                labels: todasCategorias,
                valores: todasCategorias.map(cat => dados[cat])
            };
        }

        function getAnosDisponiveis() {
            const anos = new Set(state.gastos.map(g => new Date(g.data + 'T00:00:00').getFullYear()));
             if (anos.size === 0) {
                anos.add(new Date().getFullYear());
            }
            return Array.from(anos).sort((a, b) => b - a);
        }

        function criarGrafico(canvasId, chartStateKey, config) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            if (state.charts[chartStateKey]) {
                state.charts[chartStateKey].destroy();
            }
            const ctx = canvas.getContext('2d');
            state.charts[chartStateKey] = new Chart(ctx, config);
        }

        function criarGraficoMensal() {
            const dados = processarDadosMensais(state.selectedYear);
            criarGrafico('graficoMensal', 'mensal', {
                type: 'line',
                data: {
                    labels: dados.labels,
                    datasets: [
                        { label: 'Total Geral', data: dados.total, borderColor: '#3b82f6', borderWidth: 3, tension: 0.4, fill: true, backgroundColor: 'rgba(59, 130, 246, 0.1)' },
                        { label: state.nomes[0], data: dados.pessoa1, borderColor: '#f97316', borderWidth: 2, tension: 0.4, borderDash: [5, 5] },
                        { label: state.nomes[1], data: dados.pessoa2, borderColor: '#8b5cf6', borderWidth: 2, tension: 0.4, borderDash: [5, 5] }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }
        
        function criarGraficoCategoria() {
            const dados = processarDadosPorMes(state.selectedMonthGrafico, state.selectedYear);
            const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            
            criarGrafico('graficoCategoria', 'categoria', {
                type: 'bar',
                data: {
                    labels: dados.labels,
                    datasets: [{
                        label: `Gastos em ${meses[state.selectedMonthGrafico]} de ${state.selectedYear}`,
                        data: dados.valores,
                        backgroundColor: [
                            '#3b82f6', '#8b5cf6', '#f97316', '#10b981', '#ef4444',
                            '#f59e0b', '#06b6d4', '#ec4899', '#6366f1', '#84cc16',
                            '#14b8a6', '#f43f5e', '#a855f7', '#eab308', '#22c55e'
                        ],
                        borderRadius: 6,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toFixed(2);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': R$ ' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateSelectedYear(ano) {
            state.selectedYear = parseInt(ano);
            render();
            setTimeout(() => {
                criarGraficoMensal();
                criarGraficoCategoria();
            }, 0);
        }

        function updateSelectedMonthGrafico(mes) {
            state.selectedMonthGrafico = parseInt(mes);
            render();
            setTimeout(() => {
                criarGraficoMensal();
                criarGraficoCategoria();
            }, 0);
        }

        function renderLogin() {
            return `
                <div class="min-h-screen bg-slate-100 flex items-center justify-center p-4 relative overflow-hidden">
                    <div class="absolute -top-40 -right-40 w-80 h-80 bg-purple-200 rounded-full mix-blend-multiply filter blur-xl opacity-70 float-animation"></div>
                    <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-blue-200 rounded-full mix-blend-multiply filter blur-xl opacity-70 float-animation" style="animation-delay: 1.5s;"></div>
                    
                    <div class="relative z-10 w-full max-w-md fade-in">
                        <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-2xl overflow-hidden border border-slate-200">
                            <div class="bg-gradient-to-br from-blue-500 to-purple-600 p-8 text-center">
                                <div class="inline-block bg-white/30 p-4 rounded-full mb-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                                    </svg>
                                </div>
                                <h1 class="text-3xl font-bold text-white tracking-tight">Bem-vindo(a)!</h1>
                                <p class="text-white/90 text-sm mt-1">Seu Controle Orçamentário Familiar</p>
                            </div>
                            
                            <div class="p-8">
                                ${!isFirebaseInitialized ? `
                                    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg mb-6">
                                        <p class="font-bold">Aviso</p>
                                        <p class="text-sm">A configuração do Firebase não foi encontrada. O app funcionará em modo de demonstração.</p>
                                    </div>
                                ` : ''}

                                <div class="mb-4">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Senha de Acesso</label>
                                    <div class="relative">
                                        <input
                                            type="password"
                                            value="${state.loginPassword}"
                                            oninput="state.loginPassword = this.value; state.loginError = '';"
                                            onkeypress="if(event.key === 'Enter') handleLogin()"
                                            placeholder="••••••••"
                                            class="w-full px-4 py-3 pr-10 border-2 border-slate-200 rounded-xl focus:ring-4 focus:ring-purple-200 focus:border-purple-500 transition-all"
                                            autofocus
                                        />
                                        <div class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                                        </div>
                                    </div>
                                </div>

                                ${state.loginError ? `
                                    <div class="bg-red-100 border border-red-300 text-red-800 text-sm p-3 rounded-lg mb-4 fade-in">
                                        ${state.loginError}
                                    </div>
                                ` : ''}

                                <button
                                    onclick="handleLogin()"
                                    class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-xl font-bold text-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300"
                                >
                                    Entrar
                                </button>
                            </div>
                        </div>
                        <p class="text-center mt-6 text-xs text-slate-500">🔒 Seus dados são sincronizados com segurança.</p>
                    </div>
                </div>
            `;
        }
        
        function renderDashboard() {
            const totals = getTotals();
            const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const anosDashboard = getAnosDashboard();

            const totalPessoa1 = calcularTotalPorPessoa(state.nomes[0]);
            const totalPessoa2 = calcularTotalPorPessoa(state.nomes[1]);
            const diferenca = totalPessoa1 - totalPessoa2;
            
            const diferencaAnual = calcularSaldoAnual();

            const percentualMes = state.limiteMensal > 0 ? Math.min((totals.totalGeral / state.limiteMensal) * 100, 100) : 0;
            const statusMes = percentualMes > 100 ? 'danger' : percentualMes >= 80 ? 'warning' : 'safe';
            const statusColors = {
                danger: 'bg-red-500',
                warning: 'bg-yellow-500',
                safe: 'bg-green-500'
            };

            return `
            <div class="space-y-6">
                <div class="bg-white rounded-xl shadow p-4 flex flex-wrap items-center gap-4">
                    <div class="flex items-center gap-2 flex-wrap">
                        <span class="text-sm font-semibold text-slate-600">Período:</span>
                        <select onchange="updateDashboardDate(this.value, state.dashboardYear)" class="bg-slate-100 border-transparent rounded-lg text-sm font-medium focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            ${meses.map((mes, idx) => `<option value="${idx}" ${idx === state.dashboardMonth ? 'selected' : ''}>${mes}</option>`).join('')}
                        </select>
                        <select onchange="updateDashboardDate(state.dashboardMonth, this.value)" class="bg-slate-100 border-transparent rounded-lg text-sm font-medium focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            ${anosDashboard.map(ano => `<option value="${ano}" ${ano === state.dashboardYear ? 'selected' : ''}>${ano}</option>`).join('')}
                        </select>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow p-6">
                    <h2 class="text-xl font-bold text-slate-800 mb-4">Resumo de Gastos</h2>
                    
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-6 text-white shadow-lg shadow-blue-500/30 mb-6">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <p class="text-blue-100 text-sm font-medium">Total do Mês</p>
                                <p class="text-4xl font-bold mt-1">R$ ${totals.totalGeral.toFixed(2)}</p>
                            </div>
                            <div class="text-right">
                                <input 
                                    type="number" 
                                    placeholder="Limite" 
                                    value="${state.limiteMensal || ''}" 
                                    onchange="state.limiteMensal = parseFloat(this.value) || 0; syncWithFirebase();" 
                                    class="w-24 px-2 py-1 text-sm text-slate-800 border-0 rounded-md focus:ring-2 focus:ring-white"
                                />
                                <p class="text-xs text-blue-100 mt-1">Limite mensal</p>
                            </div>
                        </div>
                        ${state.limiteMensal > 0 ? `
                            <div class="mt-3">
                                <div class="w-full bg-white/30 rounded-full h-3">
                                    <div class="${statusColors[statusMes]} h-3 rounded-full transition-all duration-500" style="width: ${percentualMes}%"></div>
                                </div>
                                <p class="text-sm font-bold text-white mt-2">${percentualMes.toFixed(1)}% do limite</p>
                            </div>
                        ` : ''}
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-gradient-to-br from-violet-50 to-purple-50 rounded-lg p-4 border border-violet-200">
                            <p class="text-sm text-violet-700 font-medium">Gastos Fixos</p>
                            <p class="text-3xl font-bold text-violet-900 mt-1">R$ ${totals.totalFixos.toFixed(2)}</p>
                        </div>
                        <div class="bg-gradient-to-br from-orange-50 to-amber-50 rounded-lg p-4 border border-orange-200">
                            <p class="text-sm text-orange-700 font-medium">Gastos Variáveis</p>
                            <p class="text-3xl font-bold text-orange-900 mt-1">R$ ${totals.totalVariaveis.toFixed(2)}</p>
                        </div>
                    </div>
                    
                    <div class="mt-6 pt-6 border-t border-slate-200">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-slate-800">Divisão de Gastos</h2>
                            <button onclick="openEditNames()" class="text-sm text-blue-600 hover:underline font-medium">Editar Nomes</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${state.nomes.map((nome, index) => {
                                const total = index === 0 ? totalPessoa1 : totalPessoa2;
                                const limite = state.limitesPorPessoa[nome] || 0;
                                const percentualBase = limite > 0 ? Math.min((total / limite) * 100, 100) : 0;
                                const percentualExcesso = limite > 0 && total > limite ? ((total - limite) / limite) * 100 : 0;
                                const ultrapassou = total > limite && limite > 0;
                                
                                return `
                                <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <p class="text-base font-semibold text-slate-700">👤 ${nome}</p>
                                            <p class="text-3xl font-bold text-slate-900 mt-1">R$ ${total.toFixed(2)}</p>
                                        </div>
                                        <div class="text-right">
                                            <input 
                                                type="number" 
                                                placeholder="Limite" 
                                                value="${limite || ''}" 
                                                onchange="state.limitesPorPessoa['${nome}'] = parseFloat(this.value) || 0; syncWithFirebase();" 
                                                class="w-24 px-2 py-1 text-sm text-slate-800 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-400"
                                            />
                                            <p class="text-xs text-slate-500 mt-1">Limite</p>
                                        </div>
                                    </div>
                                    ${limite > 0 ? `
                                        <div class="mt-3">
                                            <div class="w-full bg-slate-200 rounded-full h-3 overflow-hidden">
                                                <div class="h-3 rounded-full transition-all duration-500 flex" style="width: ${Math.min(percentualBase + percentualExcesso, 100)}%">
                                                    <div class="bg-green-500 h-full" style="width: ${ultrapassou ? (percentualBase / (percentualBase + percentualExcesso)) * 100 : 100}%"></div>
                                                    ${ultrapassou ? `<div class="bg-red-500 h-full" style="width: ${(percentualExcesso / (percentualBase + percentualExcesso)) * 100}%"></div>` : ''}
                                                </div>
                                            </div>
                                            <div class="flex justify-between items-center mt-1">
                                                <p class="text-sm font-bold ${ultrapassou ? 'text-red-600' : 'text-slate-700'}">${(percentualBase + percentualExcesso).toFixed(1)}% do limite</p>
                                                ${ultrapassou ? `<p class="text-sm text-red-600 font-bold">Excesso: R$ ${(total - limite).toFixed(2)}</p>` : ''}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                                `;
                            }).join('')}
                        </div>
                        <div class="mt-6 pt-6 border-t border-slate-200">
                            <h2 class="text-xl font-bold text-slate-800 mb-4">Resumo do Saldo</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                                    <p class="text-sm font-semibold text-indigo-800 mb-2">Saldo Total (${state.dashboardYear})</p>
                                    ${diferencaAnual === 0 ? `
                                        <div class="text-center py-2">
                                            <p class="font-semibold text-emerald-700">✅ Saldo anual equilibrado!</p>
                                        </div>
                                    ` : `
                                        <div class="text-center">
                                            <p class="text-xs text-slate-600">
                                                <span class="font-bold">${diferencaAnual < 0 ? state.nomes[0] : state.nomes[1]}</span>
                                                gastou mais
                                                <span class="font-bold">${diferencaAnual < 0 ? state.nomes[1] : state.nomes[0]}</span>
                                            </p>
                                            <p class="text-3xl font-bold text-indigo-900 mt-1">
                                                R$ ${(Math.abs(diferencaAnual) / 2).toFixed(2)}
                                            </p>
                                        </div>
                                    `}
                                </div>

                                <div class="bg-sky-50 p-4 rounded-lg border border-sky-200">
                                    <p class="text-sm font-semibold text-sky-800 mb-2">Saldo do Mês</p>
                                    ${diferenca === 0 ? `
                                        <div class="text-center py-2">
                                            <p class="font-semibold text-emerald-700">✅ Saldo do mês equilibrado!</p>
                                        </div>
                                    ` : `
                                        <div class="text-center">
                                            <p class="text-xs text-slate-600">
                                                <span class="font-bold">${diferenca < 0 ? state.nomes[0] : state.nomes[1]}</span>
                                                gastou mais
                                                <span class="font-bold">${diferenca < 0 ? state.nomes[1] : state.nomes[0]}</span>
                                            </p>
                                            <p class="text-3xl font-bold text-sky-900 mt-1">
                                                R$ ${(Math.abs(diferenca) / 2).toFixed(2)}
                                            </p>
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow p-6">
                    <h2 class="text-xl font-bold text-slate-800 mb-4">Gastos Fixos</h2>
                    <div class="space-y-4">
                        ${state.categoriasFixas.map(cat => {
                            const total = calcularTotalCategoria(cat, 'fixo');
                            const limite = state.limites[cat] || 0;
                            const status = verificarLimite(cat, total);
                            const percentual = limite > 0 ? Math.min((total / limite) * 100, 100) : 0;
                            const statusColors = {
                                danger: 'bg-red-500',
                                warning: 'bg-yellow-500',
                                safe: 'bg-green-500'
                            };
                            return `
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="font-semibold text-slate-700">${cat}</span>
                                        <div class="flex items-center gap-2">
                                            <span class="font-bold text-slate-800 text-lg">R$ ${total.toFixed(2)}</span>
                                            <div class="relative">
                                                <span class="absolute left-2 top-1/2 -translate-y-1/2 text-xs text-slate-400">R$</span>
                                                <input type="number" placeholder="Limite" value="${limite || ''}" onchange="handleSetLimite('${cat}', this.value)" class="w-24 pl-6 pr-2 py-1 border border-slate-300 rounded-md text-sm focus:ring-2 focus:ring-emerald-400"/>
                                            </div>
                                        </div>
                                    </div>
                                    ${limite > 0 ? `
                                    <div class="w-full bg-slate-200 rounded-full h-2.5 mt-1">
                                        <div class="${statusColors[status]} h-2.5 rounded-full transition-all duration-500" style="width: ${percentual}%"></div>
                                    </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                <h2 class="text-xl font-bold text-slate-800 mb-4">Gastos Variáveis</h2>
                    <div class="space-y-4">
                        ${state.categoriasVariaveis.map(cat => {
                            const total = calcularTotalCategoria(cat, 'variavel');
                            const limite = state.limites[cat] || 0;
                            const status = verificarLimite(cat, total);
                            const percentual = limite > 0 ? Math.min((total / limite) * 100, 100) : 0;
                            const statusColors = {
                                danger: 'bg-red-500',
                                warning: 'bg-yellow-500',
                                safe: 'bg-green-500'
                            };
                            return `
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="font-semibold text-slate-700">${cat}</span>
                                        <div class="flex items-center gap-2">
                                            <span class="font-bold text-slate-800 text-lg">R$ ${total.toFixed(2)}</span>
                                            <div class="relative">
                                                <span class="absolute left-2 top-1/2 -translate-y-1/2 text-xs text-slate-400">R$</span>
                                                <input type="number" placeholder="Limite" value="${limite || ''}" onchange="handleSetLimite('${cat}', this.value)" class="w-24 pl-6 pr-2 py-1 border border-slate-300 rounded-md text-sm focus:ring-2 focus:ring-blue-400"/>
                                            </div>
                                        </div>
                                    </div>
                                    ${limite > 0 ? `
                                    <div class="w-full bg-slate-200 rounded-full h-2.5 mt-1">
                                        <div class="${statusColors[status]} h-2.5 rounded-full transition-all duration-500" style="width: ${percentual}%"></div>
                                    </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>
            `;
        }
        
        function renderAddGasto() {
            return `
            <div class="bg-white rounded-xl shadow-xl p-8 max-w-2xl mx-auto border border-slate-200">
                <h2 class="text-3xl font-bold text-slate-800 mb-6 border-b pb-4">💸 Adicionar Novo Gasto</h2>
                <div class="space-y-5">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Valor (R$) <span class="text-red-500">*</span></label>
                            <input type="number" step="0.01" value="${state.formData.valor}" oninput="updateFormData('valor', this.value)" placeholder="0,00" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Data <span class="text-red-500">*</span></label>
                            <input type="date" value="${state.formData.data}" onchange="updateFormData('data', this.value)" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" style="min-width: 0; -webkit-appearance: none;"/>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Responsável <span class="text-red-500">*</span></label>
                        <select onchange="updateFormData('responsavel', this.value)" value="${state.formData.responsavel}" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- Selecione --</option>
                            ${state.nomes.map(nome => `<option value="${nome}" ${state.formData.responsavel === nome ? 'selected' : ''}>${nome}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Descrição <span class="text-red-500">*</span></label>
                        <textarea oninput="updateFormData('descricao', this.value)" placeholder="Ex: Compras da semana" rows="3" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">${state.formData.descricao}</textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Tipo de Gasto</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="updateFormData('tipo', 'variavel');" class="px-4 py-3 rounded-lg text-center font-semibold transition-colors ${state.formData.tipo === 'variavel' ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}">Variável</button>
                            <button onclick="updateFormData('tipo', 'fixo');" class="px-4 py-3 rounded-lg text-center font-semibold transition-colors ${state.formData.tipo === 'fixo' ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}">Fixo</button>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Categoria</label>
                        <select onchange="updateFormData('categoria', this.value)" value="${state.formData.categoria}" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- Selecione --</option>
                            ${(state.formData.tipo === 'fixo' ? state.categoriasFixas : state.categoriasVariaveis).map(cat => `<option value="${cat}" ${state.formData.categoria === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="handleClearForm()" class="flex-1 bg-slate-200 text-slate-800 py-4 rounded-xl font-bold text-lg hover:bg-slate-300 transition-all duration-300">
                            Limpar
                        </button>
                        <button onclick="handleAddGasto()" class="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 text-white py-4 rounded-xl font-bold text-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300">
                            Adicionar Gasto
                        </button>
                    </div>
                </div>
                <div class="mt-8 pt-4 border-t border-slate-200 text-center">
                    <button onclick="openAddCategory()" class="text-blue-600 hover:underline font-medium text-sm">Gerenciar Categorias</button>
                </div>
            </div>
            `;
        }

        function renderGraficos() {
            const anos = getAnosDisponiveis();
            const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            
            if (state.gastos.length === 0) {
                return `
                    <div class="bg-white rounded-xl shadow p-8 text-center max-w-lg mx-auto">
                        <div class="text-6xl mb-4">📊</div>
                        <h2 class="text-2xl font-bold text-slate-800 mb-2">Sem Dados para Análise</h2>
                        <p class="text-slate-600">Adicione alguns gastos para começar a ver os gráficos e insights sobre suas finanças.</p>
                    </div>
                `;
            }

            return `
                <div class="space-y-6">
                    <div class="bg-white rounded-xl shadow p-4 flex items-center gap-4">
                        <label class="text-sm font-semibold text-slate-700">Analisando o ano de:</label>
                        <select onchange="updateSelectedYear(this.value)" class="bg-slate-100 border-transparent rounded-lg text-sm font-medium focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            ${anos.map(ano => `<option value="${ano}" ${ano === state.selectedYear ? 'selected' : ''}>${ano}</option>`).join('')}
                        </select>
                    </div>

                    <div class="bg-white rounded-xl shadow p-6">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">📈 Evolução Mensal de Gastos (${state.selectedYear})</h2>
                        <div class="h-80"><canvas id="graficoMensal"></canvas></div>
                    </div>

                    <div class="bg-white rounded-xl shadow p-6">
                         <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
                            <h2 class="text-xl font-bold text-slate-800">📊 Gastos por Categoria</h2>
                            <select onchange="updateSelectedMonthGrafico(this.value)" class="bg-slate-100 border-transparent rounded-lg text-sm font-medium focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                                ${meses.map((mes, idx) => `<option value="${idx}" ${idx === state.selectedMonthGrafico ? 'selected' : ''}>${mes} ${state.selectedYear}</option>`).join('')}
                            </select>
                        </div>
                        <div class="h-80"><canvas id="graficoCategoria"></canvas></div>
                    </div>
                </div>
            `;
        }

        function renderHistorico() {
            const gastosOrdenados = [...state.gastos].sort((a, b) => new Date(b.data) - new Date(a.data));

            const gastosAgrupados = gastosOrdenados.reduce((acc, gasto) => {
                const mesAno = new Date(gasto.data + 'T00:00:00').toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                if (!acc[mesAno]) {
                    acc[mesAno] = [];
                }
                acc[mesAno].push(gasto);
                return acc;
            }, {});
            
            return `
            <div class="bg-white rounded-xl shadow p-6 max-w-3xl mx-auto">
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                    <h2 class="text-3xl font-bold text-slate-800">Histórico de Lançamentos</h2>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="state.showNotificationsReport = true; render();" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-all flex items-center gap-2 font-semibold text-sm shadow-sm hover:shadow-md">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z" /></svg>
                            Relatório de Notificações
                        </button>
                        ${state.gastos.length > 0 ? `
                            <button onclick="exportToExcel()" class="bg-emerald-500 text-white px-4 py-2 rounded-lg hover:bg-emerald-600 transition-all flex items-center gap-2 font-semibold text-sm shadow-sm hover:shadow-md">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                                Excel
                            </button>
                            <button onclick="exportToPDF()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-all flex items-center gap-2 font-semibold text-sm shadow-sm hover:shadow-md">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                                PDF
                            </button>
                        ` : ''}
                    </div>
                </div>
                ${state.gastos.length === 0 ? `
                    <p class="text-center text-slate-500 py-8">Nenhum gasto registrado ainda.</p>
                ` : `
                    <div class="space-y-8">
                        ${Object.entries(gastosAgrupados).map(([mesAno, gastosDoMes]) => {
                            const porCategoria = gastosDoMes.reduce((acc, gasto) => {
                                if (!acc[gasto.categoria]) {
                                    acc[gasto.categoria] = [];
                                }
                                acc[gasto.categoria].push(gasto);
                                return acc;
                            }, {});
                            
                            Object.keys(porCategoria).forEach(categoria => {
                                porCategoria[categoria].sort((a, b) => new Date(a.data) - new Date(b.data));
                            });
                            
                            return `
                            <div>
                                <h3 class="text-lg font-bold text-slate-600 capitalize pb-2 mb-4 border-b-2 border-slate-200">${mesAno}</h3>
                                <div class="space-y-6">
                                    ${Object.entries(porCategoria).map(([categoria, gastosCategoria]) => `
                                        <div>
                                            <h4 class="text-md font-semibold text-slate-700 mb-3 flex items-center gap-2">
                                                <span class="w-2 h-2 rounded-full bg-blue-500"></span>
                                                ${categoria}
                                            </h4>
                                            <ul class="space-y-2 ml-4">
                                                ${gastosCategoria.map(gasto => `
                                                    <li class="flex items-center justify-between p-2 bg-slate-50 rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors">
                                                        <div class="flex items-center gap-3">
                                                            <div class="text-center w-10">
                                                                <p class="font-bold text-lg text-blue-600">${new Date(gasto.data + 'T00:00:00').getDate()}</p>
                                                                <p class="text-xs text-slate-500">${new Date(gasto.data + 'T00:00:00').toLocaleDateString('pt-BR', { month: 'short' })}</p>
                                                            </div>
                                                            <div>
                                                                <p class="text-sm text-slate-600">${gasto.descricao || 'Sem descrição'}</p>
                                                                <div class="mt-1 flex items-center gap-2 text-xs">
                                                                    <span class="px-2 py-0.5 rounded-full font-medium ${gasto.tipo === 'fixo' ? 'bg-violet-100 text-violet-700' : 'bg-orange-100 text-orange-700'}">${gasto.tipo}</span>
                                                                    <span class="px-2 py-0.5 rounded-full bg-slate-200 text-slate-600">${gasto.responsavel}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="flex items-center gap-2">
                                                            <span class="font-bold text-lg text-slate-800 text-right">R$ ${gasto.valor.toFixed(2)}</span>
                                                            <button onclick="openEditGasto(${gasto.id})" class="text-slate-400 hover:text-blue-500 transition-colors p-1 rounded-full" title="Editar">
                                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                                            </button>
                                                            <button onclick="handleRemoveGasto(${gasto.id})" class="text-slate-400 hover:text-red-500 transition-colors p-1 rounded-full" title="Excluir">
                                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                                            </button>
                                                        </div>
                                                    </li>
                                                `).join('')}
                                            </ul>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                `}
            </div>
            `;
        }
        
        function renderPesquisa() {
            return `
            <div class="bg-white rounded-xl shadow p-6 max-w-3xl mx-auto">
                <h2 class="text-3xl font-bold text-slate-800 mb-6">🔍 Pesquisar Lançamentos</h2>
                
                <div class="mb-6">
                    <div class="relative">
                        <input
                            type="text"
                            value="${state.searchQuery}"
                            oninput="state.searchQuery = this.value"
                            onkeypress="if(event.key === 'Enter') handleSearch()"
                            placeholder="Digite para buscar: categoria, descrição, responsável, valor, data..."
                            class="w-full px-4 py-3 pr-24 bg-slate-50 border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            autofocus
                        />
                        <div class="absolute right-2 top-1/2 -translate-y-1/2 flex gap-2">
                            ${state.searchQuery ? `
                                <button onclick="clearSearch()" class="px-3 py-1.5 text-sm text-slate-600 hover:text-slate-800 font-medium">
                                    Limpar
                                </button>
                            ` : ''}
                            <button onclick="handleSearch()" class="px-4 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium text-sm">
                                Buscar
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 mt-2">A busca é realizada em todos os campos: categoria, descrição, responsável, valor, data e tipo.</p>
                </div>

                ${!state.searchQuery && state.searchResults.length === 0 ? `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">🔎</div>
                        <p class="text-slate-600">Digite algo no campo acima para buscar nos seus lançamentos.</p>
                    </div>
                ` : state.searchResults.length === 0 && state.searchQuery ? `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">😕</div>
                        <p class="text-slate-600">Nenhum resultado encontrado para "<strong>${state.searchQuery}</strong>".</p>
                        <p class="text-sm text-slate-500 mt-2">Tente buscar por outros termos.</p>
                    </div>
                ` : `
                    <div>
                        <div class="mb-4 flex items-center justify-between">
                            <p class="text-sm text-slate-600">
                                Encontrados <strong class="text-blue-600">${state.searchResults.length}</strong> resultado${state.searchResults.length !== 1 ? 's' : ''} para "<strong>${state.searchQuery}</strong>"
                            </p>
                        </div>
                        
                        <ul class="space-y-3">
                            ${state.searchResults.map(gasto => `
                                <li class="flex items-center justify-between p-4 bg-slate-50 rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors">
                                    <div class="flex items-center gap-4 flex-1">
                                        <div class="text-center w-16">
                                            <p class="font-bold text-lg text-blue-600">${new Date(gasto.data + 'T00:00:00').getDate()}</p>
                                            <p class="text-xs text-slate-500">${new Date(gasto.data + 'T00:00:00').toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' })}</p>
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-semibold text-slate-800">${gasto.categoria}</p>
                                            <p class="text-sm text-slate-600">${gasto.descricao || 'Sem descrição'}</p>
                                            <div class="mt-1 flex items-center gap-2 text-xs">
                                                <span class="px-2 py-0.5 rounded-full font-medium ${gasto.tipo === 'fixo' ? 'bg-violet-100 text-violet-700' : 'bg-orange-100 text-orange-700'}">${gasto.tipo}</span>
                                                <span class="px-2 py-0.5 rounded-full bg-slate-200 text-slate-600">${gasto.responsavel}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="font-bold text-lg text-slate-800 text-right whitespace-nowrap">R$ ${gasto.valor.toFixed(2)}</span>
                                        <button onclick="openEditGasto(${gasto.id})" class="text-slate-400 hover:text-blue-500 transition-colors p-1 rounded-full" title="Editar">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                        </button>
                                        <button onclick="handleRemoveGasto(${gasto.id})" class="text-slate-400 hover:text-red-500 transition-colors p-1 rounded-full" title="Excluir">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                        </button>
                                    </div>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `}
            </div>
            `;
        }
        
        function renderConfig() {
            return `
            <div class="bg-white rounded-xl shadow p-6 max-w-2xl mx-auto">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">⚙️ Configurações</h2>
                <div class="space-y-6">
                    <div class="border-b border-slate-200 pb-6">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Segurança</h3>
                        <button onclick="state.showChangePassword = true; render();" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700 transition-colors font-medium text-sm">
                            Alterar Senha
                        </button>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Sessão</h3>
                        <button onclick="handleLogout()" class="bg-red-600 text-white px-5 py-2.5 rounded-lg hover:bg-red-700 transition-colors font-medium text-sm">Sair do Sistema</button>
                    </div>
                </div>
            </div>
            `;
        }
        
        function renderNotificationsReportModal() {
            if (!state.showNotificationsReport) return '';

            const sortedNotifications = [...state.notificacoes].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            const getActionBadge = (action) => {
                switch (action) {
                    case 'criação': return '<span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Criação</span>';
                    case 'edição': return '<span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Edição</span>';
                    case 'exclusão': return '<span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Exclusão</span>';
                    default: return '';
                }
            };

            const innerHtml = `
                <div class="flex justify-between items-center mb-4 border-b pb-3">
                    <h3 class="text-2xl font-bold text-slate-800">Relatório de Notificações</h3>
                    <button onclick="state.showNotificationsReport = false; render();" class="text-slate-400 hover:text-slate-800 text-3xl leading-none">&times;</button>
                </div>
                <div class="max-h-[70vh] overflow-y-auto pr-2">
                    ${sortedNotifications.length === 0 ? '<p class="text-center text-slate-500 py-12">Nenhuma notificação registrada.</p>' : ''}
                    <ul class="space-y-3">
                        ${sortedNotifications.map(log => `
                            <li class="p-3 bg-slate-50 rounded-lg border border-slate-200">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        ${getActionBadge(log.action)}
                                        <p class="text-xs text-slate-500 mt-1">
                                            ${new Date(log.timestamp).toLocaleString('pt-BR')}
                                        </p>
                                    </div>
                                    <span class="font-bold text-lg text-slate-800">
                                        R$ ${log.gasto.valor.toFixed(2)}
                                    </span>
                                </div>
                                <div>
                                    <p class="font-semibold text-slate-700">${log.gasto.categoria}</p>
                                    <p class="text-sm text-slate-600">${log.gasto.descricao}</p>
                                    <p class="text-xs text-slate-500 mt-1">
                                        Responsável: <strong>${log.gasto.responsavel}</strong> | Data do Gasto: <strong>${new Date(log.gasto.data + 'T00:00:00').toLocaleDateString('pt-BR')}</strong>
                                    </p>
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;

            return `
            <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 fade-in" onclick="if(event.target === this) { state.showNotificationsReport = false; render(); }">
                <div class="bg-white rounded-xl p-6 max-w-3xl w-full shadow-2xl">
                    ${innerHtml}
                </div>
            </div>`;
        }

        function updateFormData(field, value) {
            if (field === 'tipo') {
                state.formData.tipo = value;
                state.formData.categoria = '';
                render(); // Apenas quando muda o tipo para atualizar as categorias disponíveis
            } else if (field === 'valor') {
                state.formData[field] = value ? parseFloat(value) : '';
            } else {
                state.formData[field] = value;
            }
        }

        function openAddCategory() {
            state.showAddCategory = true;
            render();
        }

        function openEditNames() {
            state.tempNome1 = state.nomes[0];
            state.tempNome2 = state.nomes[1];
            state.showEditNames = true;
            render();
        }

        function render() {
            if (!state.isAuthenticated) {
                document.getElementById('root').innerHTML = renderLogin();
                return;
            }
            
            const content = `
            <div class="min-h-screen" onclick="if(state.showMenu && event.target.closest('header') === null) { state.showMenu = false; render(); }">
                <header class="bg-white/80 backdrop-blur-sm shadow-sm sticky top-0 z-40">
                    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                         <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                            Orçamento Familiar
                        </h1>
                        <div class="relative">
                            <button onclick="event.stopPropagation(); state.showMenu = !state.showMenu; render();" class="flex items-center gap-2 px-4 py-2 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors font-semibold text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
                                </svg>
                                Menu
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            ${state.showMenu ? `
                                <div class="absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden z-50">
                                    <button onclick="changeTab('adicionar'); state.showMenu = false;" class="w-full text-left px-4 py-3 hover:bg-slate-50 transition-colors flex items-center gap-3 ${state.activeTab === 'adicionar' ? 'bg-blue-50 text-blue-700 font-semibold' : 'text-slate-700'}">
                                        <span class="text-lg">➕</span>
                                        <span>Adicionar</span>
                                    </button>
                                    <button onclick="changeTab('dashboard'); state.showMenu = false;" class="w-full text-left px-4 py-3 hover:bg-slate-50 transition-colors flex items-center gap-3 ${state.activeTab === 'dashboard' ? 'bg-blue-50 text-blue-700 font-semibold' : 'text-slate-700'}">
                                        <span class="text-lg">📊</span>
                                        <span>Dashboard</span>
                                    </button>
                                    <button onclick="changeTab('graficos'); state.showMenu = false;" class="w-full text-left px-4 py-3 hover:bg-slate-50 transition-colors flex items-center gap-3 ${state.activeTab === 'graficos' ? 'bg-blue-50 text-blue-700 font-semibold' : 'text-slate-700'}">
                                        <span class="text-lg">📈</span>
                                        <span>Gráficos</span>
                                    </button>
                                    <button onclick="changeTab('historico'); state.showMenu = false;" class="w-full text-left px-4 py-3 hover:bg-slate-50 transition-colors flex items-center gap-3 ${state.activeTab === 'historico' ? 'bg-blue-50 text-blue-700 font-semibold' : 'text-slate-700'}">
                                        <span class="text-lg">📝</span>
                                        <span>Histórico</span>
                                    </button>
                                    <button onclick="changeTab('pesquisa'); state.showMenu = false;" class="w-full text-left px-4 py-3 hover:bg-slate-50 transition-colors flex items-center gap-3 ${state.activeTab === 'pesquisa' ? 'bg-blue-50 text-blue-700 font-semibold' : 'text-slate-700'}">
                                        <span class="text-lg">🔍</span>
                                        <span>Pesquisa</span>
                                    </button>
                                    <div class="border-t border-slate-200"></div>
                                    <button onclick="changeTab('config'); state.showMenu = false;" class="w-full text-left px-4 py-3 hover:bg-slate-50 transition-colors flex items-center gap-3 ${state.activeTab === 'config' ? 'bg-blue-50 text-blue-700 font-semibold' : 'text-slate-700'}">
                                        <span class="text-lg">⚙️</span>
                                        <span>Configurações</span>
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </header>
                
                <main class="container mx-auto px-4 py-8">
                    <div class="fade-in">
                        ${state.activeTab === 'adicionar' ? renderAddGasto() : ''}
                        ${state.activeTab === 'dashboard' ? renderDashboard() : ''}
                        ${state.activeTab === 'graficos' ? renderGraficos() : ''}
                        ${state.activeTab === 'historico' ? renderHistorico() : ''}
                        ${state.activeTab === 'pesquisa' ? renderPesquisa() : ''}
                        ${state.activeTab === 'config' ? renderConfig() : ''}
                    </div>
                </main>
            </div>

            ${renderModal('showAddCategory', `
                <h3 class="text-xl font-bold text-slate-800 mb-4">Gerenciar Categorias</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Tipo</label>
                        <select onchange="state.categoryType = this.value" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                            <option value="fixo" ${state.categoryType === 'fixo' ? 'selected' : ''}>Fixo</option>
                            <option value="variavel" ${state.categoryType === 'variavel' ? 'selected' : ''}>Variável</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Nome da Nova Categoria</label>
                            <input type="text" value="${state.newCategoryName}" oninput="state.newCategoryName = this.value" class="w-full px-4 py-2 border border-slate-300 rounded-lg"/>
                            <div class="flex gap-3 pt-2">
                                <button onclick="state.showAddCategory = false; render();" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300">Fechar</button>
                                <button onclick="handleAddCategory()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Adicionar</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Categorias Existentes (${state.categoryType === 'fixo' ? 'Fixas' : 'Variáveis'})</label>
                            <div class="space-y-2 max-h-48 overflow-auto pr-2">
                                ${state.categoryType === 'fixo' ? state.categoriasFixas.map(cat => `
                                    <div class="flex items-center justify-between p-2 bg-slate-50 rounded-lg border border-slate-200">
                                        <div class="truncate"><strong>${cat}</strong></div>
                                        <div class="flex items-center gap-2">
                                            <button onclick="handleEditCategory('fixo', '${'${cat}'.replace(/'/g,"\\'") }')" class="text-sm px-2 py-1 bg-amber-100 rounded-md hover:bg-amber-200">Editar</button>
                                            <button onclick="handleDeleteCategory('fixo', '${'${cat}'.replace(/'/g,"\\'") }')" class="text-sm px-2 py-1 bg-red-100 rounded-md hover:bg-red-200">Excluir</button>
                                        </div>
                                    </div>
                                `).join('') : ''}
                                
                                ${state.categoryType === 'variavel' ? state.categoriasVariaveis.map(cat => `
                                    <div class="flex items-center justify-between p-2 bg-slate-50 rounded-lg border border-slate-200">
                                        <div class="truncate"><strong>${cat}</strong></div>
                                        <div class="flex items-center gap-2">
                                            <button onclick="handleEditCategory('variavel', '${'${cat}'.replace(/'/g,"\\'") }')" class="text-sm px-2 py-1 bg-amber-100 rounded-md hover:bg-amber-200">Editar</button>
                                            <button onclick="handleDeleteCategory('variavel', '${'${cat}'.replace(/'/g,"\\'") }')" class="text-sm px-2 py-1 bg-red-100 rounded-md hover:bg-red-200">Excluir</button>
                                        </div>
                                    </div>
                                `).join('') : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `)}${renderModal('showEditNames', `
                <h3 class="text-xl font-bold text-slate-800 mb-4">Editar Nomes</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Pessoa 1</label>
                        <input type="text" value="${state.tempNome1}" oninput="state.tempNome1 = this.value" class="w-full px-4 py-2 border border-slate-300 rounded-lg"/>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Pessoa 2</label>
                        <input type="text" value="${state.tempNome2}" oninput="state.tempNome2 = this.value" class="w-full px-4 py-2 border border-slate-300 rounded-lg"/>
                    </div>
                    <div class="flex gap-3 pt-2">
                        <button onclick="state.showEditNames = false; render();" class="flex-1 px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300">Cancelar</button>
                        <button onclick="handleSaveNames()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar</button>
                    </div>
                </div>
            `)}
            
            ${renderModal('showChangePassword', `
                <h3 class="text-xl font-bold text-slate-800 mb-4">Alterar Senha</h3>
                 <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Nova Senha</label>
                        <input type="password" value="${state.newPassword}" oninput="state.newPassword = this.value;" placeholder="Mínimo 6 caracteres" class="w-full px-4 py-2 border border-slate-300 rounded-lg"/>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Confirmar Nova Senha</label>
                        <input type="password" value="${state.confirmPassword}" oninput="state.confirmPassword = this.value;" placeholder="Digite novamente" class="w-full px-4 py-2 border border-slate-300 rounded-lg"/>
                    </div>
                    ${state.passwordError ? `<div class="bg-red-100 border border-red-300 text-red-800 px-4 py-3 rounded-lg text-sm">${state.passwordError}</div>` : ''}
                    <div class="flex gap-3">
                        <button onclick="state.showChangePassword = false; state.passwordError = ''; render();" class="flex-1 px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300">Cancelar</button>
                        <button onclick="handleChangePassword()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar</button>
                    </div>
                </div>
            `)}

            ${renderModal('showEditGasto', `
                <h3 class="text-xl font-bold text-slate-800 mb-4">✏️ Editar Gasto</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Tipo de Gasto</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="updateFormData('tipo', 'variavel');" class="px-4 py-2 rounded-lg text-center font-semibold transition-colors ${state.formData.tipo === 'variavel' ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}">Variável</button>
                            <button onclick="updateFormData('tipo', 'fixo');" class="px-4 py-2 rounded-lg text-center font-semibold transition-colors ${state.formData.tipo === 'fixo' ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}">Fixo</button>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Categoria</label>
                        <select onchange="updateFormData('categoria', this.value)" class="w-full px-4 py-2 bg-slate-50 border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- Selecione --</option>
                            ${(state.formData.tipo === 'fixo' ? state.categoriasFixas : state.categoriasVariaveis).map(cat => `<option value="${cat}" ${state.formData.categoria === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Valor (R$) <span class="text-red-500">*</span></label>
                            <input type="number" step="0.01" value="${state.formData.valor}" oninput="updateFormData('valor', this.value)" placeholder="0,00" class="w-full px-4 py-2 bg-slate-50 border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Data <span class="text-red-500">*</span></label>
                            <input type="date" value="${state.formData.data}" onchange="updateFormData('data', this.value)" class="w-full px-4 py-2 bg-slate-50 border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Responsável <span class="text-red-500">*</span></label>
                        <select onchange="updateFormData('responsavel', this.value)" class="w-full px-4 py-2 bg-slate-50 border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- Selecione --</option>
                            ${state.nomes.map(nome => `<option value="${nome}" ${state.formData.responsavel === nome ? 'selected' : ''}>${nome}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Descrição <span class="text-red-500">*</span></label>
                        <textarea oninput="updateFormData('descricao', this.value)" placeholder="Ex: Compras da semana" rows="2" class="w-full px-4 py-2 bg-slate-50 border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">${state.formData.descricao}</textarea>                    </div>
                    
                    <div class="flex gap-3 pt-2">
                        <button onclick="cancelEditGasto()" class="flex-1 px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 font-medium">Cancelar</button>
                        <button onclick="handleSaveEditGasto()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">Salvar Alterações</button>
                    </div>
                </div>
            `)}
            
            ${renderNotificationsReportModal()}
            `;
            
            document.getElementById('root').innerHTML = content;
        }
        
        function renderModal(stateKey, innerHtml) {
            if (!state[stateKey]) return '';
            return `
            <div class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 fade-in" onclick="if(event.target === this) { state.${stateKey} = false; render(); }">
                <div class="bg-white rounded-xl p-6 max-w-md w-full shadow-2xl">
                    ${innerHtml}
                </div>
            </div>`;
        }

        function changeTab(tab) {
            state.activeTab = tab;
            window.scrollTo(0, 0);
            render();
            
            if (tab === 'graficos' && state.gastos.length > 0) {
                setTimeout(() => {
                    const anos = getAnosDisponiveis();
                    if (!state.selectedYear || !anos.includes(state.selectedYear)) {
                        state.selectedYear = anos[0];
                    }
                    if (state.selectedMonthGrafico === undefined) {
                        state.selectedMonthGrafico = new Date().getMonth();
                    }
                    criarGraficoMensal();
                    criarGraficoCategoria();
                }, 100);
            }
        }

        if (isFirebaseInitialized) {
            checkStoredPassword();
        }
        render();

    </script>
</body>
</html>
