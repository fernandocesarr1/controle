<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Or√ßament√°rio Familiar</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* Estilos personalizados e anima√ß√µes */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f8fafc; /* Fundo cinza claro */
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .float-animation {
            animation: float 4s ease-in-out infinite;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        // Configura√ß√£o do Firebase (use suas chaves reais aqui)
        const firebaseConfig = {
            apiKey: "AIzaSyAgopSuSjeQ26UL85eYb11w4BbbNtBg5QE",
            authDomain: "orcamento-familiar-dc2e6.firebaseapp.com",
            databaseURL: "https://orcamento-familiar-dc2e6-default-rtdb.firebaseio.com",
            projectId: "orcamento-familiar-dc2e6",
            storageBucket: "orcamento-familiar-dc2e6.firebasestorage.app",
            messagingSenderId: "21809188621",
            appId: "1:21809188621:web:103d45c3353106ebf5aa44",
            measurementId: "G-4E95DZRK3F"
        };

        // Inicializar Firebase
        let database;
        let isFirebaseInitialized = false;

        try {
            if (firebaseConfig.apiKey && !firebaseConfig.apiKey.includes("SUA_API_KEY")) {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                isFirebaseInitialized = true;
            } else {
                 console.warn("Configura√ß√£o do Firebase n√£o preenchida. O app funcionar√° em modo offline.");
            }
        } catch (error) {
            console.error("Erro ao inicializar Firebase:", error);
        }

        // Estado da aplica√ß√£o
        let state = {
            isAuthenticated: false,
            showLogin: true,
            showChangePassword: false,
            loginPassword: '',
            newPassword: '',
            confirmPassword: '',
            loginError: '',
            passwordError: '',
            activeTab: 'dashboard',
            categoriasFixas: ['Escola', 'Diarista', 'Internet', '√Ågua', 'Luz', 'Clube'],
            categoriasVariaveis: ['Supermercado', 'Farm√°cia', 'Lazer'],
            limites: {},
            gastos: [],
            nomes: ['Pessoa 1', 'Pessoa 2'],
            showAddCategory: false,
            showEditNames: false,
            showEditGasto: false,
            editingGastoId: null,
            selectedYear: new Date().getFullYear(),
            selectedMonth: new Date().getMonth(),
            selectedMonthGrafico: new Date().getMonth(),
            dashboardYear: new Date().getFullYear(),
            dashboardMonth: new Date().getMonth(),
            formData: {
                tipo: 'variavel',
                categoria: '',
                valor: '',
                data: new Date().toISOString().split('T')[0],
                descricao: '',
                responsavel: 'Pessoa 1'
            },
            tempNome1: 'Pessoa 1',
            tempNome2: 'Pessoa 2',
            newCategoryName: '',
            categoryType: 'fixo',
            charts: {}
        };

        const DEFAULT_PASSWORD = 'familia2024';

        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }

        function checkStoredPassword() {
            if (!isFirebaseInitialized) return;
            database.ref('auth/passwordHash').once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    database.ref('auth/passwordHash').set(simpleHash(DEFAULT_PASSWORD));
                }
            });
        }

        function handleLogin() {
            if (!state.loginPassword) {
                state.loginError = 'Por favor, digite a senha.';
                render();
                return;
            }

            if (!isFirebaseInitialized) {
                state.loginError = 'Firebase n√£o est√° configurado corretamente.';
                render();
                return;
            }

            const passwordHash = simpleHash(state.loginPassword);
            
            database.ref('auth/passwordHash').once('value', (snapshot) => {
                const storedHash = snapshot.val();
                
                if (storedHash === passwordHash) {
                    state.isAuthenticated = true;
                    state.showLogin = false;
                    state.loginError = '';
                    state.loginPassword = '';
                    loadFromFirebase();
                    render();
                } else {
                    state.loginError = 'Senha incorreta. Tente novamente.';
                    render();
                }
            });
        }
        
        function handleChangePassword() {
            if (!state.newPassword || !state.confirmPassword) {
                state.passwordError = 'Preencha todos os campos';
                render();
                return;
            }

            if (state.newPassword.length < 6) {
                state.passwordError = 'A senha deve ter pelo menos 6 caracteres';
                render();
                return;
            }

            if (state.newPassword !== state.confirmPassword) {
                state.passwordError = 'As senhas n√£o coincidem';
                render();
                return;
            }

            const newPasswordHash = simpleHash(state.newPassword);
            database.ref('auth/passwordHash').set(newPasswordHash);
            
            state.showChangePassword = false;
            state.newPassword = '';
            state.confirmPassword = '';
            state.passwordError = '';
            alert('Senha alterada com sucesso! ‚úÖ');
            render();
        }

        function handleLogout() {
            state.isAuthenticated = false;
            state.showLogin = true;
            state.activeTab = 'dashboard';
            render();
        }

        function syncWithFirebase() {
            if (!isFirebaseInitialized) return;
            database.ref('appData').set({
                categorias: {
                    fixas: state.categoriasFixas,
                    variaveis: state.categoriasVariaveis
                },
                limites: state.limites,
                nomes: state.nomes
            });
        }

        function saveGastoToFirebase(gasto) {
            if (!isFirebaseInitialized) return;
            database.ref('gastos/' + gasto.id).set(gasto);
        }

        function removeGastoFromFirebase(id) {
            if (!isFirebaseInitialized) return;
            database.ref('gastos/' + id).remove();
        }

        function loadFromFirebase() {
            if (!isFirebaseInitialized) return;

            database.ref('appData').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    state.categoriasFixas = data.categorias?.fixas || state.categoriasFixas;
                    state.categoriasVariaveis = data.categorias?.variaveis || state.categoriasVariaveis;
                    state.limites = data.limites || state.limites;
                    state.nomes = data.nomes || state.nomes;
                    state.formData.responsavel = state.nomes[0];
                    render();
                }
            });

            database.ref('gastos').on('value', (snapshot) => {
                const data = snapshot.val();
                state.gastos = data ? Object.values(data) : [];
                render();
            });
        }

        function calcularTotalCategoria(categoria, tipo) {
            return state.gastos
                .filter(g => {
                    const dataGasto = new Date(g.data + 'T00:00:00');
                    return g.categoria === categoria && 
                        g.tipo === tipo && 
                        dataGasto.getMonth() === state.dashboardMonth && 
                        dataGasto.getFullYear() === state.dashboardYear;
                })
                .reduce((sum, g) => sum + g.valor, 0);
        }

        function calcularTotalPorPessoa(pessoa) {
            return state.gastos
                .filter(g => {
                    const dataGasto = new Date(g.data + 'T00:00:00');
                    return g.responsavel === pessoa && 
                        dataGasto.getMonth() === state.dashboardMonth && 
                        dataGasto.getFullYear() === state.dashboardYear;
                })
                .reduce((sum, g) => sum + g.valor, 0);
        }

        function updateDashboardDate(mes, ano) {
            state.dashboardMonth = parseInt(mes);
            state.dashboardYear = parseInt(ano);
            render();
        }

        function getAnosDashboard() {
            const anos = new Set(state.gastos.map(g => new Date(g.data + 'T00:00:00').getFullYear()));
            if (anos.size === 0) {
                anos.add(new Date().getFullYear());
            }
            return Array.from(anos).sort((a, b) => b - a);
        }
        
        function verificarLimite(categoria, total) {
            const limite = state.limites[categoria];
            if (!limite || limite <= 0) return 'safe';
            const percentual = (total / limite) * 100;
            if (percentual > 100) return 'danger';
            if (percentual >= 80) return 'warning';
            return 'safe';
        }

        function handleAddCategory() {
            if (state.newCategoryName.trim()) {
                const list = state.categoryType === 'fixo' ? state.categoriasFixas : state.categoriasVariaveis;
                if (!list.includes(state.newCategoryName.trim())) {
                    list.push(state.newCategoryName.trim());
                    syncWithFirebase();
                }
                state.newCategoryName = '';
                state.showAddCategory = false;
                render();
            }
        }

        function handleAddGasto() {
            if (state.formData.categoria && state.formData.valor > 0 && state.formData.data && state.formData.responsavel) {
                const novoGasto = {
                    id: Date.now(),
                    ...state.formData,
                    valor: parseFloat(state.formData.valor)
                };
                state.gastos.push(novoGasto);
                saveGastoToFirebase(novoGasto);
                state.formData = {
                    ...state.formData,
                    tipo: 'variavel',
                    categoria: '',
                    valor: '',
                    descricao: '',
                };
                alert('Gasto adicionado com sucesso! üéâ');
                changeTab('dashboard');
            } else {
                alert('‚ö†Ô∏è Por favor, preencha Categoria, Valor e Data para adicionar um gasto.');
            }
        }

        function handleRemoveGasto(id) {
            if (confirm('Tem certeza que deseja excluir este gasto?')) {
                state.gastos = state.gastos.filter(g => g.id !== id);
                removeGastoFromFirebase(id);
                render();
            }
        }

        function openEditGasto(id) {
            const gasto = state.gastos.find(g => g.id === id);
            if (gasto) {
                state.editingGastoId = id;
                state.formData = {
                    tipo: gasto.tipo,
                    categoria: gasto.categoria,
                    valor: gasto.valor,
                    data: gasto.data,
                    descricao: gasto.descricao || '',
                    responsavel: gasto.responsavel
                };
                state.showEditGasto = true;
                render();
            }
        }

        function handleSaveEditGasto() {
            if (state.formData.categoria && state.formData.valor > 0 && state.formData.data && state.formData.responsavel) {
                const index = state.gastos.findIndex(g => g.id === state.editingGastoId);
                if (index !== -1) {
                    state.gastos[index] = {
                        id: state.editingGastoId,
                        ...state.formData,
                        valor: parseFloat(state.formData.valor)
                    };
                    saveGastoToFirebase(state.gastos[index]);
                    state.showEditGasto = false;
                    state.editingGastoId = null;
                    state.formData = {
                        tipo: 'variavel',
                        categoria: '',
                        valor: '',
                        data: new Date().toISOString().split('T')[0],
                        descricao: '',
                        responsavel: state.nomes[0]
                    };
                    alert('Gasto atualizado com sucesso! ‚úÖ');
                    render();
                }
            } else {
                alert('‚ö†Ô∏è Por favor, preencha Categoria, Valor e Data para salvar o gasto.');
            }
        }

        function cancelEditGasto() {
            state.showEditGasto = false;
            state.editingGastoId = null;
            state.formData = {
                tipo: 'variavel',
                categoria: '',
                valor: '',
                data: new Date().toISOString().split('T')[0],
                descricao: '',
                responsavel: state.nomes[0]
            };
            render();
        }

        function handleSetLimite(categoria, valor) {
            state.limites[categoria] = parseFloat(valor) || 0;
            syncWithFirebase();
            render();
        }

        function handleSaveNames() {
            state.nomes = [state.tempNome1.trim(), state.tempNome2.trim()];
            state.formData.responsavel = state.nomes[0];
            syncWithFirebase();
            state.showEditNames = false;
            render();
        }

        function exportToExcel() {
            if (state.gastos.length === 0) {
                alert('‚ö†Ô∏è N√£o h√° gastos para exportar!');
                return;
            }

            const dadosExportacao = state.gastos.map(gasto => ({
                'Data': new Date(gasto.data + 'T00:00:00').toLocaleDateString('pt-BR'),
                'Tipo': gasto.tipo === 'fixo' ? 'Fixo' : 'Vari√°vel',
                'Categoria': gasto.categoria,
                'Respons√°vel': gasto.responsavel,
                'Valor (R$)': gasto.valor.toFixed(2),
                'Descri√ß√£o': gasto.descricao || '-'
            }));

            dadosExportacao.sort((a, b) => {
                const dataA = a['Data'].split('/').reverse().join('');
                const dataB = b['Data'].split('/').reverse().join('');
                return dataB.localeCompare(dataA);
            });
            
            const ws = XLSX.utils.json_to_sheet(dadosExportacao);
            ws['!cols'] = [ { wch: 12 }, { wch: 10 }, { wch: 20 }, { wch: 15 }, { wch: 12 }, { wch: 40 } ];
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Gastos');
            const nomeArquivo = `Orcamento_Familiar_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.xlsx`;
            XLSX.writeFile(wb, nomeArquivo);
            alert('‚úÖ Planilha exportada com sucesso!');
        }

        function exportToPDF() {
            if (state.gastos.length === 0) {
                alert('‚ö†Ô∏è N√£o h√° gastos para exportar!');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // T√≠tulo
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('Controle Or√ßament√°rio Familiar', 14, 20);
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, 14, 28);

            // Preparar dados
            const dadosExportacao = state.gastos.map(gasto => [
                new Date(gasto.data + 'T00:00:00').toLocaleDateString('pt-BR'),
                gasto.tipo === 'fixo' ? 'Fixo' : 'Vari√°vel',
                gasto.categoria,
                gasto.responsavel,
                `R$ ${gasto.valor.toFixed(2)}`,
                gasto.descricao || '-'
            ]);

            // Ordenar por data (mais recente primeiro)
            dadosExportacao.sort((a, b) => {
                const dataA = a[0].split('/').reverse().join('');
                const dataB = b[0].split('/').reverse().join('');
                return dataB.localeCompare(dataA);
            });

            // Criar tabela
            doc.autoTable({
                startY: 35,
                head: [['Data', 'Tipo', 'Categoria', 'Respons√°vel', 'Valor', 'Descri√ß√£o']],
                body: dadosExportacao,
                theme: 'striped',
                headStyles: { fillColor: [59, 130, 246], fontSize: 10, fontStyle: 'bold' },
                styles: { fontSize: 9, cellPadding: 3 },
                columnStyles: {
                    0: { cellWidth: 25 },
                    1: { cellWidth: 20 },
                    2: { cellWidth: 30 },
                    3: { cellWidth: 30 },
                    4: { cellWidth: 25, halign: 'right' },
                    5: { cellWidth: 'auto' }
                }
            });

            // Salvar
            const nomeArquivo = `Orcamento_Familiar_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.pdf`;
            doc.save(nomeArquivo);
            alert('‚úÖ PDF exportado com sucesso!');
        }

        function getTotals() {
            const gastosDoMes = state.gastos.filter(g => {
                const dataGasto = new Date(g.data + 'T00:00:00');
                return dataGasto.getMonth() === state.dashboardMonth && 
                    dataGasto.getFullYear() === state.dashboardYear;
            });
            
            const totalFixos = gastosDoMes.filter(g => g.tipo === 'fixo').reduce((sum, g) => sum + g.valor, 0);
            const totalVariaveis = gastosDoMes.filter(g => g.tipo === 'variavel').reduce((sum, g) => sum + g.valor, 0);
            return { totalFixos, totalVariaveis, totalGeral: totalFixos + totalVariaveis };
        }
        
        function processarDadosMensais(ano) {
            const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            const dados = {
                labels: meses,
                total: Array(12).fill(0),
                pessoa1: Array(12).fill(0),
                pessoa2: Array(12).fill(0)
            };
            state.gastos.forEach(gasto => {
                const dataGasto = new Date(gasto.data + 'T00:00:00');
                if (dataGasto.getFullYear() === ano) {
                    const mes = dataGasto.getMonth();
                    dados.total[mes] += gasto.valor;
                    if (gasto.responsavel === state.nomes[0]) {
                        dados.pessoa1[mes] += gasto.valor;
                    } else if (gasto.responsavel === state.nomes[1]) {
                        dados.pessoa2[mes] += gasto.valor;
                    }
                }
            });
            return dados;
        }

        function processarDadosPorMes(mes, ano) {
            const todasCategorias = [...state.categoriasFixas, ...state.categoriasVariaveis].sort();
            const dados = {};
            
            todasCategorias.forEach(cat => {
                dados[cat] = 0;
            });
            
            state.gastos.forEach(gasto => {
                const dataGasto = new Date(gasto.data + 'T00:00:00');
                if (dataGasto.getFullYear() === ano && dataGasto.getMonth() === mes) {
                    if (dados[gasto.categoria] !== undefined) {
                        dados[gasto.categoria] += gasto.valor;
                    }
                }
            });
            
            return {
                labels: todasCategorias,
                valores: todasCategorias.map(cat => dados[cat])
            };
        }

        function getAnosDisponiveis() {
            const anos = new Set(state.gastos.map(g => new Date(g.data + 'T00:00:00').getFullYear()));
             if (anos.size === 0) {
                anos.add(new Date().getFullYear());
            }
            return Array.from(anos).sort((a, b) => b - a);
        }

        function criarGrafico(canvasId, chartStateKey, config) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            if (state.charts[chartStateKey]) {
                state.charts[chartStateKey].destroy();
            }
            const ctx = canvas.getContext('2d');
            state.charts[chartStateKey] = new Chart(ctx, config);
        }

        function criarGraficoMensal() {
            const dados = processarDadosMensais(state.selectedYear);
            criarGrafico('graficoMensal', 'mensal', {
                type: 'line',
                data: {
                    labels: dados.labels,
                    datasets: [
                        { label: 'Total Geral', data: dados.total, borderColor: '#3b82f6', borderWidth: 3, tension: 0.4, fill: true, backgroundColor: 'rgba(59, 130, 246, 0.1)' },
                        { label: state.nomes[0], data: dados.pessoa1, borderColor: '#f97316', borderWidth: 2, tension: 0.4, borderDash: [5, 5] },
                        { label: state.nomes[1], data: dados.pessoa2, borderColor: '#8b5cf6', borderWidth: 2, tension: 0.4, borderDash: [5, 5] }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }
        
        function criarGraficoCategoria() {
            const dados = processarDadosPorMes(state.selectedMonthGrafico, state.selectedYear);
            const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            
            criarGrafico('graficoCategoria', 'categoria', {
                type: 'bar',
                data: {
                    labels: dados.labels,
                    datasets: [{
                        label: `Gastos em ${meses[state.selectedMonthGrafico]} de ${state.selectedYear}`,
                        data: dados.valores,
                        backgroundColor: [
                            '#3b82f6', '#8b5cf6', '#f97316', '#10b981', '#ef4444',
                            '#f59e0b', '#06b6d4', '#ec4899', '#6366f1', '#84cc16',
                            '#14b8a6', '#f43f5e', '#a855f7', '#eab308', '#22c55e'
                        ],
                        borderRadius: 6,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toFixed(2);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': R$ ' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateSelectedYear(ano) {
            state.selectedYear = parseInt(ano);
            render();
            setTimeout(() => {
                criarGraficoMensal();
                criarGraficoCategoria();
            }, 0);
        }

        function updateSelectedMonthGrafico(mes) {
            state.selectedMonthGrafico = parseInt(mes);
            render();
            setTimeout(criarGraficoCategoria, 0);
        }

        function renderLogin() {
            return `
                <div class="min-h-screen bg-slate-100 flex items-center justify-center p-4 relative overflow-hidden">
                    <div class="absolute -top-40 -right-40 w-80 h-80 bg-purple-200 rounded-full mix-blend-multiply filter blur-xl opacity-70 float-animation"></div>
                    <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-blue-200 rounded-full mix-blend-multiply filter blur-xl opacity-70 float-animation" style="animation-delay: 1.5s;"></div>
                    
                    <div class="relative z-10 w-full max-w-md fade-in">
                        <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-2xl overflow-hidden border border-slate-200">
                            <div class="bg-gradient-to-br from-blue-500 to-purple-600 p-8 text-center">
                                <div class="inline-block bg-white/30 p-4 rounded-full mb-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                                    </svg>
                                </div>
                                <h1 class="text-3xl font-bold text-white tracking-tight">Bem-vindo(a)!</h1>
                                <p class="text-white/90 text-sm mt-1">Seu Controle Or√ßament√°rio Familiar</p>
                            </div>
                            
                            <div class="p-8">
                                ${!isFirebaseInitialized ? `
                                    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg mb-6">
                                        <p class="font-bold">Aviso</p>
                                        <p class="text-sm">A configura√ß√£o do Firebase n√£o foi encontrada. O app funcionar√° em modo de demonstra√ß√£o.</p>
                                    </div>
                                ` : ''}

                                <div class="mb-4">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Senha de Acesso</label>
                                    <div class="relative">
                                        <input
                                            type="password"
                                            value="${state.loginPassword}"
                                            oninput="state.loginPassword = this.value; state.loginError = '';"
                                            onkeypress="if(event.key === 'Enter') handleLogin()"
                                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                            class="w-full px-4 py-3 pr-10 border-2 border-slate-200 rounded-xl focus:ring-4 focus:ring-purple-200 focus:border-purple-500 transition-all"
                                            autofocus
                                        />
                                        <div class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                                        </div>
                                    </div>
                                </div>

                                ${state.loginError ? `
                                    <div class="bg-red-100 border border-red-300 text-red-800 text-sm p-3 rounded-lg mb-4 fade-in">
                                        ${state.loginError}
                                    </div>
                                ` : ''}

                                <button
                                    onclick="handleLogin()"
                                    class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-xl font-bold text-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300"
                                >
                                    Entrar
                                </button>
                            </div>
                        </div>
                        <p class="text-center mt-6 text-xs text-slate-500">üîí Seus dados s√£o sincronizados com seguran√ßa.</p>
                    </div>
                </div>
            `;
        }
        
        function renderDashboard() {
            const totals = getTotals();
            const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const anosDashboard = getAnosDashboard();

            const totalPessoa1 = calcularTotalPorPessoa(state.nomes[0]);
            const totalPessoa2 = calcularTotalPorPessoa(state.nomes[1]);
            const diferenca = totalPessoa1 - totalPessoa2;
            const valorAcerto = Math.abs(diferenca / 2);

            return `
            <div class="space-y-6">
                <div class="bg-white rounded-xl shadow p-4 flex flex-wrap items-center gap-4">
                    <div class="flex items-center gap-2 flex-wrap">
                        <span class="text-sm font-semibold text-slate-600">Per√≠odo:</span>
                        <select onchange="updateDashboardDate(this.value, state.dashboardYear)" class="bg-slate-100 border-transparent rounded-lg text-sm font-medium focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            ${meses.map((mes, idx) => `<option value="${idx}" ${idx === state.dashboardMonth ? 'selected' : ''}>${mes}</option>`).join('')}
                        </select>
                        <select onchange="updateDashboardDate(state.dashboardMonth, this.value)" class="bg-slate-100 border-transparent rounded-lg text-sm font-medium focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            ${anosDashboard.map(ano => `<option value="${ano}" ${ano === state.dashboardYear ? 'selected' : ''}>${ano}</option>`).join('')}
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-6 text-white shadow-lg shadow-blue-500/30">
                        <p class="text-blue-100 text-sm font-medium">Total do M√™s</p>
                        <p class="text-4xl font-bold mt-1">R$ ${totals.totalGeral.toFixed(2)}</p>
                    </div>
                    <div class="bg-gradient-to-br from-violet-500 to-purple-600 rounded-xl p-6 text-white shadow-lg shadow-purple-500/30">
                        <p class="text-purple-100 text-sm font-medium">Gastos Fixos</p>
                        <p class="text-4xl font-bold mt-1">R$ ${totals.totalFixos.toFixed(2)}</p>
                    </div>
                    <div class="bg-gradient-to-br from-orange-500 to-amber-600 rounded-xl p-6 text-white shadow-lg shadow-orange-500/30">
                        <p class="text-amber-100 text-sm font-medium">Gastos Vari√°veis</p>
                        <p class="text-4xl font-bold mt-1">R$ ${totals.totalVariaveis.toFixed(2)}</p>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-slate-800">Divis√£o de Gastos</h2>
                        <button onclick="openEditNames()" class="text-sm text-blue-600 hover:underline font-medium">Editar Nomes</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${state.nomes.map((nome, index) => {
                            const total = index === 0 ? totalPessoa1 : totalPessoa2;
                            return `
                            <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                                <p class="text-base font-semibold text-slate-700">üë§ ${nome}</p>
                                <p class="text-3xl font-bold text-slate-900 mt-1">R$ ${total.toFixed(2)}</p>
                            </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="mt-6 pt-6 border-t border-slate-200">
                        <h3 class="text-md font-bold text-slate-700 mb-2">üéØ Acerto de Contas</h3>
                        ${diferenca === 0 ? `
                            <div class="p-4 bg-emerald-50 rounded-lg border border-emerald-200 text-center">
                                <p class="text-emerald-700 font-semibold">‚úÖ Contas equilibradas este m√™s!</p>
                            </div>
                        ` : `
                        <div class="p-4 bg-slate-50 rounded-lg border border-slate-200 text-center flex flex-col md:flex-row items-center justify-center gap-2">
                            <span class="font-semibold text-slate-800">${diferenca < 0 ? state.nomes[0] : state.nomes[1]}</span>
                            <span>precisa transferir</span>
                            <span class="font-bold text-xl text-emerald-600">R$ ${valorAcerto.toFixed(2)}</span>
                            <span>para</span>
                            <span class="font-semibold text-slate-800">${diferenca < 0 ? state.nomes[1] : state.nomes[0]}</span>
                        </div>
                        `}
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow p-6">
                    <h2 class="text-xl font-bold text-slate-800 mb-4">Gastos Vari√°veis</h2>
                    <div class="space-y-4">
                        ${state.categoriasVariaveis.map(cat => {
                            const total = calcularTotalCategoria(cat, 'variavel');
                            const limite = state.limites[cat] || 0;
                            const status = verificarLimite(cat, total);
                            const percentual = limite > 0 ? Math.min((total / limite) * 100, 100) : 0;
                            const statusColors = {
                                danger: 'bg-red-500',
                                warning: 'bg-yellow-500',
                                safe: 'bg-green-500'
                            };
                            return `
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="font-semibold text-slate-700">${cat}</span>
                                        <div class="flex items-center gap-2">
                                            <span class="font-bold text-slate-800 text-lg">R$ ${total.toFixed(2)}</span>
                                            <div class="relative">
                                                <span class="absolute left-2 top-1/2 -translate-y-1/2 text-xs text-slate-400">R$</span>
                                                <input type="number" placeholder="Limite" value="${limite || ''}" onchange="handleSetLimite('${cat}', this.value)" class="w-24 pl-6 pr-2 py-1 border border-slate-300 rounded-md text-sm focus:ring-2 focus:ring-blue-400"/>
                                            </div>
                                        </div>
                                    </div>
                                    ${limite > 0 ? `
                                    <div class="w-full bg-slate-200 rounded-full h-2.5 mt-1">
                                        <div class="${statusColors[status]} h-2.5 rounded-full transition-all duration-500" style="width: ${percentual}%"></div>
                                    </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow p-6">
                    <h2 class="text-xl font-bold text-slate-800 mb-4">Gastos Fixos</h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        ${state.categoriasFixas.map(cat => {
                            const total = calcularTotalCategoria(cat, 'fixo');
                            return `
                                <div class="bg-slate-50 rounded-lg p-3 border border-slate-200">
                                    <p class="text-sm text-slate-600 font-medium">${cat}</p>
                                    <p class="text-lg font-bold text-slate-800 mt-1">R$ ${total.toFixed(2)}</p>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>
            `;
        }
        
        function renderAddGasto() {
            return `
            <div class="bg-white rounded-xl shadow-xl p-8 max-w-2xl mx-auto border border-slate-200">
                <h2 class="text-3xl font-bold text-slate-800 mb-6 border-b pb-4">üí∏ Adicionar Novo Gasto</h2>
                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Tipo de Gasto</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="updateFormData('tipo', 'variavel');" class="px-4 py-3 rounded-lg text-center font-semibold transition-colors ${state.formData.tipo === 'variavel' ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}">Vari√°vel</button>
                            <button onclick="updateFormData('tipo', 'fixo');" class="px-4 py-3 rounded-lg text-center font-semibold transition-colors ${state.formData.tipo === 'fixo' ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}">Fixo</button>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Categoria</label>
                        <select onchange="updateFormData('categoria', this.value)" value="${state.formData.categoria}" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- Selecione --</option>
                            ${(state.formData.tipo === 'fixo' ? state.categoriasFixas : state.categoriasVariaveis).map(cat => `<option value="${cat}" ${state.formData.categoria === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                        </select>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Valor (R$)</label>
                            <input type="number" step="0.01" value="${state.formData.valor}" oninput="updateFormData('valor', this.value)" placeholder="0,00" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Data</label>
                            <input type="date" value="${state.formData.data}" onchange="updateFormData('data', this.value)" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Respons√°vel</label>
                        <select onchange="updateFormData('responsavel', this.value)" value="${state.formData.responsavel}" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            ${state.nomes.map(nome => `<option value="${nome}" ${state.formData.responsavel === nome ? 'selected' : ''}>${nome}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Descri√ß√£o (Opcional)</label>
                        <textarea oninput="updateFormData('descricao', this.value)" placeholder="Ex: Compras da semana" rows="3" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">${state.formData.descricao}</textarea>
                    </div>
                    
                    <button onclick="handleAddGasto()" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-4 rounded-xl font-bold text-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 mt-4">
                        Adicionar Gasto
                    </button>
                </div>
                <div class="mt-8 pt-4 border-t border-slate-200 text-center">
                    <button onclick="openAddCategory()" class="text-blue-600 hover:underline font-medium text-sm">Gerenciar Categorias</button>
                </div>
            </div>
            `;
        }

        function renderGraficos() {
            const anos = getAnosDisponiveis();
            const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            
            if (state.gastos.length === 0) {
                return `
                    <div class="bg-white rounded-xl shadow p-8 text-center max-w-lg mx-auto">
                        <div class="text-6xl mb-4">üìä</div>
                        <h2 class="text-2xl font-bold text-slate-800 mb-2">Sem Dados para An√°lise</h2>
                        <p class="text-slate-600">Adicione alguns gastos para come√ßar a ver os gr√°ficos e insights sobre suas finan√ßas.</p>
                    </div>
                `;
            }

            return `
                <div class="space-y-6">
                    <div class="bg-white rounded-xl shadow p-4 flex items-center gap-4">
                        <label class="text-sm font-semibold text-slate-700">Analisando o ano de:</label>
                        <select onchange="updateSelectedYear(this.value)" class="bg-slate-100 border-transparent rounded-lg text-sm font-medium focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            ${anos.map(ano => `<option value="${ano}" ${ano === state.selectedYear ? 'selected' : ''}>${ano}</option>`).join('')}
                        </select>
                    </div>

                    <div class="bg-white rounded-xl shadow p-6">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">üìà Evolu√ß√£o Mensal de Gastos (${state.selectedYear})</h2>
                        <div class="h-96"><canvas id="graficoMensal"></canvas></div>
                    </div>

                    <div class="bg-white rounded-xl shadow p-6">
                         <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
                            <h2 class="text-xl font-bold text-slate-800">üìä Gastos por Categoria</h2>
                            <select onchange="updateSelectedMonthGrafico(this.value)" class="bg-slate-100 border-transparent rounded-lg text-sm font-medium focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                                ${meses.map((mes, idx) => `<option value="${idx}" ${idx === state.selectedMonthGrafico ? 'selected' : ''}>${mes} ${state.selectedYear}</option>`).join('')}
                            </select>
                        </div>
                        <div class="h-96"><canvas id="graficoCategoria"></canvas></div>
                    </div>
                </div>
            `;
        }

        function renderHistorico() {
            const gastosOrdenados = [...state.gastos].sort((a, b) => new Date(b.data) - new Date(a.data));

            const gastosAgrupados = gastosOrdenados.reduce((acc, gasto) => {
                const mesAno = new Date(gasto.data + 'T00:00:00').toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                if (!acc[mesAno]) {
                    acc[mesAno] = [];
                }
                acc[mesAno].push(gasto);
                return acc;
            }, {});
            
            return `
            <div class="bg-white rounded-xl shadow p-6 max-w-4xl mx-auto">
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                    <h2 class="text-3xl font-bold text-slate-800">Hist√≥rico de Lan√ßamentos</h2>
                    ${state.gastos.length > 0 ? `
                        <div class="flex gap-2">
                            <button onclick="exportToExcel()" class="bg-emerald-500 text-white px-4 py-2 rounded-lg hover:bg-emerald-600 transition-all flex items-center gap-2 font-semibold text-sm shadow-sm hover:shadow-md">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                                Excel
                            </button>
                            <button onclick="exportToPDF()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-all flex items-center gap-2 font-semibold text-sm shadow-sm hover:shadow-md">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                                PDF
                            </button>
                        </div>
                    ` : ''}
                </div>
                ${state.gastos.length === 0 ? `
                    <p class="text-center text-slate-500 py-8">Nenhum gasto registrado ainda.</p>
                ` : `
                    <div class="space-y-8">
                        ${Object.entries(gastosAgrupados).map(([mesAno, gastosDoMes]) => `
                            <div>
                                <h3 class="text-lg font-bold text-slate-600 capitalize pb-2 mb-4 border-b-2 border-slate-200">${mesAno}</h3>
                                <ul class="space-y-3">
                                    ${gastosDoMes.map(gasto => `
                                        <li class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors">
                                            <div class="flex items-center gap-4">
                                                <div class="text-center w-12">
                                                    <p class="font-bold text-lg text-blue-600">${new Date(gasto.data + 'T00:00:00').getDate()}</p>
                                                    <p class="text-xs text-slate-500">${new Date(gasto.data + 'T00:00:00').toLocaleDateString('pt-BR', { month: 'short' })}</p>
                                                </div>
                                                <div>
                                                    <p class="font-semibold text-slate-800">${gasto.categoria}</p>
                                                    <p class="text-sm text-slate-500">${gasto.descricao || 'Sem descri√ß√£o'}</p>
                                                    <div class="mt-1 flex items-center gap-2 text-xs">
                                                        <span class="px-2 py-0.5 rounded-full font-medium ${gasto.tipo === 'fixo' ? 'bg-violet-100 text-violet-700' : 'bg-orange-100 text-orange-700'}">${gasto.tipo}</span>
                                                        <span class="px-2 py-0.5 rounded-full bg-slate-200 text-slate-600">${gasto.responsavel}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <span class="font-bold text-lg text-slate-800 text-right">R$ ${gasto.valor.toFixed(2)}</span>
                                                <button onclick="openEditGasto(${gasto.id})" class="text-slate-400 hover:text-blue-500 transition-colors p-1 rounded-full" title="Editar">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                                </button>
                                                <button onclick="handleRemoveGasto(${gasto.id})" class="text-slate-400 hover:text-red-500 transition-colors p-1 rounded-full" title="Excluir">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                                </button>
                                            </div>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        `).join('')}
                    </div>
                `}
            </div>
            `;
        }
        
        function renderConfig() {
            return `
            <div class="bg-white rounded-xl shadow p-6 max-w-2xl mx-auto">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">‚öôÔ∏è Configura√ß√µes</h2>
                <div class="space-y-6">
                    <div class="border-b border-slate-200 pb-6">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Seguran√ßa</h3>
                        <button onclick="state.showChangePassword = true; render();" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700 transition-colors font-medium text-sm">
                            Alterar Senha
                        </button>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Sess√£o</h3>
                        <button onclick="handleLogout()" class="bg-red-600 text-white px-5 py-2.5 rounded-lg hover:bg-red-700 transition-colors font-medium text-sm">Sair do Sistema</button>
                    </div>
                </div>
            </div>
            `;
        }

        function updateFormData(field, value) {
            if (field === 'tipo') {
                state.formData.categoria = '';
                render(); // Apenas quando muda o tipo para atualizar as categorias dispon√≠veis
            } else if (field === 'valor') {
                state.formData[field] = value ? parseFloat(value) : '';
            } else {
                state.formData[field] = value;
            }
        }

        function openAddCategory() {
            state.showAddCategory = true;
            render();
        }

        function openEditNames() {
            state.tempNome1 = state.nomes[0];
            state.tempNome2 = state.nomes[1];
            state.showEditNames = true;
            render();
        }

        function render() {
            if (!state.isAuthenticated) {
                document.getElementById('root').innerHTML = renderLogin();
                return;
            }

            const activeTabClass = 'bg-blue-600 text-white shadow-md';
            const inactiveTabClass = 'text-slate-600 hover:bg-slate-200';

            const content = `
            <div class="min-h-screen">
                <header class="bg-white/80 backdrop-blur-sm shadow-sm sticky top-0 z-40">
                    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                         <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                            Or√ßamento Familiar
                        </h1>
                        <nav class="bg-slate-100 rounded-full p-1 flex items-center gap-1">
                            <button onclick="changeTab('dashboard')" class="px-4 py-1.5 rounded-full font-semibold text-sm transition-all ${state.activeTab === 'dashboard' ? activeTabClass : inactiveTabClass}">Dashboard</button>
                            <button onclick="changeTab('adicionar')" class="px-4 py-1.5 rounded-full font-semibold text-sm transition-all ${state.activeTab === 'adicionar' ? activeTabClass : inactiveTabClass}">Adicionar</button>
                            <button onclick="changeTab('graficos')" class="px-4 py-1.5 rounded-full font-semibold text-sm transition-all ${state.activeTab === 'graficos' ? activeTabClass : inactiveTabClass}">Gr√°ficos</button>
                            <button onclick="changeTab('historico')" class="px-4 py-1.5 rounded-full font-semibold text-sm transition-all ${state.activeTab === 'historico' ? activeTabClass : inactiveTabClass}">Hist√≥rico</button>
                            <button onclick="changeTab('config')" title="Configura√ß√µes" class="w-9 h-7 flex items-center justify-center rounded-full font-semibold text-sm transition-all ${state.activeTab === 'config' ? activeTabClass : inactiveTabClass}">‚öôÔ∏è</button>
                        </nav>
                    </div>
                </header>
                
                <main class="container mx-auto px-4 py-8">
                    <div class="fade-in">
                        ${state.activeTab === 'dashboard' ? renderDashboard() : ''}
                        ${state.activeTab === 'adicionar' ? renderAddGasto() : ''}
                        ${state.activeTab === 'graficos' ? renderGraficos() : ''}
                        ${state.activeTab === 'historico' ? renderHistorico() : ''}
                        ${state.activeTab === 'config' ? renderConfig() : ''}
                    </div>
                </main>
            </div>

            ${renderModal('showAddCategory', `
                <h3 class="text-xl font-bold text-slate-800 mb-4">Gerenciar Categorias</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Tipo</label>
                        <select onchange="state.categoryType = this.value; render();" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                            <option value="fixo" ${state.categoryType === 'fixo' ? 'selected' : ''}>Fixo</option>
                            <option value="variavel" ${state.categoryType === 'variavel' ? 'selected' : ''}>Vari√°vel</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Nome da Nova Categoria</label>
                        <input type="text" value="${state.newCategoryName}" oninput="state.newCategoryName = this.value" placeholder="Ex: Transporte" class="w-full px-4 py-2 border border-slate-300 rounded-lg"/>
                    </div>
                    <div class="flex gap-3 pt-2">
                        <button onclick="state.showAddCategory = false; state.newCategoryName = ''; render();" class="flex-1 px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300">Fechar</button>
                        <button onclick="handleAddCategory()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Adicionar</button>
                    </div>
                </div>
            `)}

            ${renderModal('showEditNames', `
                <h3 class="text-xl font-bold text-slate-800 mb-4">Editar Nomes</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Pessoa 1</label>
                        <input type="text" value="${state.tempNome1}" oninput="state.tempNome1 = this.value" class="w-full px-4 py-2 border border-slate-300 rounded-lg"/>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Pessoa 2</label>
                        <input type="text" value="${state.tempNome2}" oninput="state.tempNome2 = this.value" class="w-full px-4 py-2 border border-slate-300 rounded-lg"/>
                    </div>
                    <div class="flex gap-3 pt-2">
                        <button onclick="state.showEditNames = false; render();" class="flex-1 px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300">Cancelar</button>
                        <button onclick="handleSaveNames()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar</button>
                    </div>
                </div>
            `)}
            
            ${renderModal('showChangePassword', `
                <h3 class="text-xl font-bold text-slate-800 mb-4">Alterar Senha</h3>
                 <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Nova Senha</label>
                        <input type="password" value="${state.newPassword}" oninput="state.newPassword = this.value;" placeholder="M√≠nimo 6 caracteres" class="w-full px-4 py-2 border border-slate-300 rounded-lg"/>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Confirmar Nova Senha</label>
                        <input type="password" value="${state.confirmPassword}" oninput="state.confirmPassword = this.value;" placeholder="Digite novamente" class="w-full px-4 py-2 border border-slate-300 rounded-lg"/>
                    </div>
                    ${state.passwordError ? `<div class="bg-red-100 border border-red-300 text-red-800 px-4 py-3 rounded-lg text-sm">${state.passwordError}</div>` : ''}
                    <div class="flex gap-3">
                        <button onclick="state.showChangePassword = false; state.passwordError = ''; render();" class="flex-1 px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300">Cancelar</button>
                        <button onclick="handleChangePassword()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar</button>
                    </div>
                </div>
            `)}

            ${renderModal('showEditGasto', `
                <h3 class="text-xl font-bold text-slate-800 mb-4">‚úèÔ∏è Editar Gasto</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Tipo de Gasto</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="updateFormData('tipo', 'variavel');" class="px-4 py-2 rounded-lg text-center font-semibold transition-colors ${state.formData.tipo === 'variavel' ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}">Vari√°vel</button>
                            <button onclick="updateFormData('tipo', 'fixo');" class="px-4 py-2 rounded-lg text-center font-semibold transition-colors ${state.formData.tipo === 'fixo' ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}">Fixo</button>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Categoria</label>
                        <select onchange="updateFormData('categoria', this.value)" class="w-full px-4 py-2 bg-slate-50 border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- Selecione --</option>
                            ${(state.formData.tipo === 'fixo' ? state.categoriasFixas : state.categoriasVariaveis).map(cat => `<option value="${cat}" ${state.formData.categoria === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Valor (R$)</label>
                            <input type="number" step="0.01" value="${state.formData.valor}" oninput="updateFormData('valor', this.value)" placeholder="0,00" class="w-full px-4 py-2 bg-slate-50 border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Data</label>
                            <input type="date" value="${state.formData.data}" onchange="updateFormData('data', this.value)" class="w-full px-4 py-2 bg-slate-50 border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Respons√°vel</label>
                        <select onchange="updateFormData('responsavel', this.value)" class="w-full px-4 py-2 bg-slate-50 border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            ${state.nomes.map(nome => `<option value="${nome}" ${state.formData.responsavel === nome ? 'selected' : ''}>${nome}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Descri√ß√£o (Opcional)</label>
                        <textarea oninput="updateFormData('descricao', this.value)" placeholder="Ex: Compras da semana" rows="2" class="w-full px-4 py-2 bg-slate-50 border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">${state.formData.descricao}</textarea>
                    </div>
                    
                    <div class="flex gap-3 pt-2">
                        <button onclick="cancelEditGasto()" class="flex-1 px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 font-medium">Cancelar</button>
                        <button onclick="handleSaveEditGasto()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">Salvar Altera√ß√µes</button>
                    </div>
                </div>
            `)}
            `;
            
            document.getElementById('root').innerHTML = content;
        }
        
        function renderModal(stateKey, innerHtml) {
            if (!state[stateKey]) return '';
            return `
            <div class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 fade-in" onclick="if(event.target === this) { state.${stateKey} = false; render(); }">
                <div class="bg-white rounded-xl p-6 max-w-md w-full shadow-2xl">
                    ${innerHtml}
                </div>
            </div>`;
        }

        function changeTab(tab) {
            state.activeTab = tab;
            window.scrollTo(0, 0);
            render();
            
            if (tab === 'graficos' && state.gastos.length > 0) {
                setTimeout(() => {
                    const anos = getAnosDisponiveis();
                    if (!state.selectedYear || !anos.includes(state.selectedYear)) {
                        state.selectedYear = anos[0];
                    }
                    if (state.selectedMonthGrafico === undefined) {
                        state.selectedMonthGrafico = new Date().getMonth();
                    }
                    criarGraficoMensal();
                    criarGraficoCategoria();
                }, 100);
            }
        }

        if (isFirebaseInitialized) {
            checkStoredPassword();
        }
        render();

    </script>
</body>
</html>
