<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Or√ßament√°rio Familiar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <style>
        body {
            /* Usando um stack de fontes moderno e limpo */
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }
        
        /* Estilo de foco aprimorado para inputs */
        input:focus, select:focus, textarea:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); /* ring-blue-500/50 */
            border-color: #3b82f6; /* blue-500 */
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); } /* Flutua√ß√£o mais suave */
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); } /* Entrada mais suave */
            to { opacity: 1; transform: translateY(0); }
        }
        
        .float-animation {
            animation: float 4s ease-in-out infinite;
        }
        
        .fade-in {
            animation: fadeIn 0.4s ease-out; /* Fade-in mais r√°pido */
        }

        /* Custom scrollbar para um toque t√©cnico */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* slate-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="root"></div>

    <script>
       // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAgopSuSjeQ26UL85eYb11w4BbbNtBg5QE",
  authDomain: "orcamento-familiar-dc2e6.firebaseapp.com",
  projectId: "orcamento-familiar-dc2e6",
  storageBucket: "orcamento-familiar-dc2e6.firebasestorage.app",
  messagingSenderId: "21809188621",
  appId: "1:21809188621:web:103d45c3353106ebf5aa44",
  measurementId: "G-4E95DZRK3F"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);

        // Inicializar Firebase
        let database;
        let isFirebaseInitialized = false;

        try {
            if (firebaseConfig.apiKey !== "SUA_API_KEY_AQUI") {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                isFirebaseInitialized = true;
            }
        } catch (error) {
            console.error("Erro ao inicializar Firebase:", error);
        }

        // Estado da aplica√ß√£o
        let state = {
            isAuthenticated: false,
            showLogin: true,
            showChangePassword: false,
            loginPassword: '',
            newPassword: '',
            confirmPassword: '',
            loginError: '',
            passwordError: '',
            activeTab: 'dashboard',
            categoriasFixas: ['Escola', 'Diarista', 'Internet', '√Ågua', 'Luz', 'Clube'],
            categoriasVariaveis: ['Supermercado', 'Farm√°cia', 'Lazer'],
            limites: {},
            gastos: [],
            nomes: ['Fernando', 'Estef√¢nia'],
            showAddCategory: false,
            showEditNames: false,
            selectedCategory: '',
            selectedYear: new Date().getFullYear(),
            formData: {
                tipo: 'fixo',
                categoria: '',
                valor: '',
                data: new Date().toISOString().split('T')[0],
                descricao: '',
                responsavel: 'Fernando'
            },
            tempNome1: 'Fernando',
            tempNome2: 'Estef√¢nia',
            newCategoryName: '',
            categoryType: 'fixo',
            charts: {}
        };

        const DEFAULT_PASSWORD = 'familia2024';

        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }

        function checkStoredPassword() {
            if (!isFirebaseInitialized) return;
            database.ref('auth/passwordHash').once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    database.ref('auth/passwordHash').set(simpleHash(DEFAULT_PASSWORD));
                }
            });
        }

        function handleLogin() {
            if (!state.loginPassword) {
                state.loginError = 'Digite a senha';
                render();
                return;
            }

            if (!isFirebaseInitialized) {
                state.loginError = 'Firebase n√£o configurado';
                render();
                return;
            }

            const passwordHash = simpleHash(state.loginPassword);
            
            database.ref('auth/passwordHash').once('value', (snapshot) => {
                const storedHash = snapshot.val();
                
                if (storedHash === passwordHash) {
                    state.isAuthenticated = true;
                    state.showLogin = false;
                    state.loginError = '';
                    state.loginPassword = '';
                    loadFromFirebase();
                    render();
                } else {
                    state.loginError = 'Senha incorreta';
                    render();
                }
            });
        }

        function handleChangePassword() {
            if (!state.newPassword || !state.confirmPassword) {
                state.passwordError = 'Preencha todos os campos';
                render();
                return;
            }

            if (state.newPassword.length < 6) {
                state.passwordError = 'A senha deve ter pelo menos 6 caracteres';
                render();
                return;
            }

            if (state.newPassword !== state.confirmPassword) {
                state.passwordError = 'As senhas n√£o coincidem';
                render();
                return;
            }

            const newPasswordHash = simpleHash(state.newPassword);
            database.ref('auth/passwordHash').set(newPasswordHash);
            
            state.showChangePassword = false;
            state.newPassword = '';
            state.confirmPassword = '';
            state.passwordError = '';
            alert('Senha alterada com sucesso! ‚úÖ');
            render();
        }

        function handleLogout() {
            state.isAuthenticated = false;
            state.showLogin = true;
            state.activeTab = 'dashboard';
            render();
        }

        function syncWithFirebase() {
            if (!isFirebaseInitialized) return;
            database.ref('categorias').set({
                fixas: state.categoriasFixas,
                variaveis: state.categoriasVariaveis
            });
            database.ref('limites').set(state.limites);
            database.ref('nomes').set(state.nomes);
        }

        function saveGastoToFirebase(gasto) {
            if (!isFirebaseInitialized) return;
            database.ref('gastos/' + gasto.id).set(gasto);
        }

        function removeGastoFromFirebase(id) {
            if (!isFirebaseInitialized) return;
            database.ref('gastos/' + id).remove();
        }

        function loadFromFirebase() {
            if (!isFirebaseInitialized) return;

            database.ref('categorias').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    state.categoriasFixas = data.fixas || state.categoriasFixas;
                    state.categoriasVariaveis = data.variaveis || state.categoriasVariaveis;
                    render();
                }
            });

            database.ref('limites').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    state.limites = data;
                    render();
                }
            });

            database.ref('nomes').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    state.nomes = data;
                    render();
                }
            });

            database.ref('gastos').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    state.gastos = Object.values(data);
                    render();
                }
            });
        }

        function calcularTotalCategoria(categoria, tipo) {
            return state.gastos
                .filter(g => g.categoria === categoria && g.tipo === tipo)
                .reduce((sum, g) => sum + g.valor, 0);
        }

        function calcularTotalPorPessoa(pessoa) {
            return state.gastos
                .filter(g => g.responsavel === pessoa)
                .reduce((sum, g) => sum + g.valor, 0);
        }

        function verificarLimite(categoria, total) {
            const limite = state.limites[categoria];
            if (!limite) return null;
            const percentual = (total / limite) * 100;
            if (percentual >= 100) return 'danger';
            if (percentual >= 80) return 'warning';
            return 'safe';
        }

        function handleAddCategory() {
            if (state.newCategoryName.trim()) {
                if (state.categoryType === 'fixo') {
                    state.categoriasFixas.push(state.newCategoryName);
                } else {
                    state.categoriasVariaveis.push(state.newCategoryName);
                }
                syncWithFirebase();
                state.newCategoryName = '';
                state.showAddCategory = false;
                render();
            }
        }

        function handleAddGasto() {
            if (state.formData.categoria && state.formData.valor && state.formData.data && state.formData.responsavel) {
                const novoGasto = {
                    id: Date.now(),
                    ...state.formData,
                    valor: parseFloat(state.formData.valor)
                };
                state.gastos.push(novoGasto);
                saveGastoToFirebase(novoGasto);
                state.formData = {
                    tipo: 'fixo',
                    categoria: '',
                    valor: '',
                    data: new Date().toISOString().split('T')[0],
                    descricao: '',
                    responsavel: state.nomes[0]
                };
                render();
            }
        }

        function handleRemoveGasto(id) {
            state.gastos = state.gastos.filter(g => g.id !== id);
            removeGastoFromFirebase(id);
            render();
        }

        function handleSetLimite(categoria, valor) {
            state.limites[categoria] = parseFloat(valor) || 0;
            syncWithFirebase();
            render();
        }

        function handleSaveNames() {
            state.nomes = [state.tempNome1, state.tempNome2];
            syncWithFirebase();
            state.showEditNames = false;
            render();
        }

        function exportToExcel() {
            if (state.gastos.length === 0) {
                alert('‚ö†Ô∏è N√£o h√° gastos para exportar!');
                return;
            }

            const dadosExportacao = state.gastos.map(gasto => ({
                'Data': new Date(gasto.data + 'T00:00:00').toLocaleDateString('pt-BR'),
                'Tipo': gasto.tipo === 'fixo' ? 'Fixo' : 'Vari√°vel',
                'Categoria': gasto.categoria,
                'Respons√°vel': gasto.responsavel,
                'Valor (R$)': gasto.valor.toFixed(2),
                'Descri√ß√£o': gasto.descricao || '-'
            }));

            dadosExportacao.sort((a, b) => {
                const dataA = a['Data'].split('/').reverse().join('');
                const dataB = b['Data'].split('/').reverse().join('');
                return dataB.localeCompare(dataA);
            });

            const totals = getTotals();
            const resumo = [
                { 'Data': 'RESUMO GERAL', 'Tipo': '', 'Categoria': '', 'Respons√°vel': '', 'Valor (R$)': '', 'Descri√ß√£o': '' },
                { 'Data': 'Total Geral', 'Tipo': '', 'Categoria': '', 'Respons√°vel': '', 'Valor (R$)': totals.totalGeral.toFixed(2), 'Descri√ß√£o': '' },
                { 'Data': 'Total Fixos', 'Tipo': '', 'Categoria': '', 'Respons√°vel': '', 'Valor (R$)': totals.totalFixos.toFixed(2), 'Descri√ß√£o': '' },
                { 'Data': 'Total Vari√°veis', 'Tipo': '', 'Categoria': '', 'Respons√°vel': '', 'Valor (R$)': totals.totalVariaveis.toFixed(2), 'Descri√ß√£o': '' },
                { 'Data': '', 'Tipo': '', 'Categoria': '', 'Respons√°vel': '', 'Valor (R$)': '', 'Descri√ß√£o': '' },
                { 'Data': state.nomes[0], 'Tipo': '', 'Categoria': '', 'Respons√°vel': '', 'Valor (R$)': calcularTotalPorPessoa(state.nomes[0]).toFixed(2), 'Descri√ß√£o': '' },
                { 'Data': state.nomes[1], 'Tipo': '', 'Categoria': '', 'Respons√°vel': '', 'Valor (R$)': calcularTotalPorPessoa(state.nomes[1]).toFixed(2), 'Descri√ß√£o': '' },
                { 'Data': '', 'Tipo': '', 'Categoria': '', 'Respons√°vel': '', 'Valor (R$)': '', 'Descri√ß√£o': '' },
                { 'Data': 'DETALHAMENTO', 'Tipo': '', 'Categoria': '', 'Respons√°vel': '', 'Valor (R$)': '', 'Descri√ß√£o': '' }
            ];

            const dadosCompletos = [...resumo, ...dadosExportacao];
            const ws = XLSX.utils.json_to_sheet(dadosCompletos);
            ws['!cols'] = [
                { wch: 12 }, { wch: 10 }, { wch: 15 }, 
                { wch: 15 }, { wch: 12 }, { wch: 30 }
            ];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Gastos');

            const dataAtual = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-');
            const nomeArquivo = `Orcamento_Familiar_${dataAtual}.xlsx`;

            XLSX.writeFile(wb, nomeArquivo);
            alert('‚úÖ Planilha exportada com sucesso!');
        }

        function getTotals() {
            const totalFixos = state.gastos.filter(g => g.tipo === 'fixo').reduce((sum, g) => sum + g.valor, 0);
            const totalVariaveis = state.gastos.filter(g => g.tipo === 'variavel').reduce((sum, g) => sum + g.valor, 0);
            return { totalFixos, totalVariaveis, totalGeral: totalFixos + totalVariaveis };
        }

        function processarDadosMensais(ano) {
            const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            const dadosMensais = {
                labels: meses,
                total: new Array(12).fill(0),
                pessoa1: new Array(12).fill(0),
                pessoa2: new Array(12).fill(0)
            };

            state.gastos.forEach(gasto => {
                const dataGasto = new Date(gasto.data + 'T00:00:00');
                if (dataGasto.getFullYear() === ano) {
                    const mes = dataGasto.getMonth();
                    dadosMensais.total[mes] += gasto.valor;
                    if (gasto.responsavel === state.nomes[0]) {
                        dadosMensais.pessoa1[mes] += gasto.valor;
                    } else {
                        dadosMensais.pessoa2[mes] += gasto.valor;
                    }
                }
            });

            return dadosMensais;
        }

        function processarDadosCategoria(categoria, ano) {
            const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            const dados = new Array(12).fill(0);

            state.gastos.forEach(gasto => {
                const dataGasto = new Date(gasto.data + 'T00:00:00');
                if (dataGasto.getFullYear() === ano && gasto.categoria === categoria) {
                    const mes = dataGasto.getMonth();
                    dados[mes] += gasto.valor;
                }
            });

            return { labels: meses, valores: dados };
        }

        function getAnosDisponiveis() {
            const anos = new Set();
            state.gastos.forEach(gasto => {
                const ano = new Date(gasto.data + 'T00:00:00').getFullYear();
                anos.add(ano);
            });
            return Array.from(anos).sort((a, b) => b - a);
        }

        function criarGraficoMensal() {
            const canvas = document.getElementById('graficoMensal');
            if (!canvas) return;

            if (state.charts.mensal) {
                state.charts.mensal.destroy();
            }

            const dados = processarDadosMensais(state.selectedYear);
            const ctx = canvas.getContext('2d');
            
            state.charts.mensal = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dados.labels,
                    datasets: [
                        {
                            label: 'Total Geral',
                            data: dados.total,
                            borderColor: 'rgb(37, 99, 235)', /* blue-600 */
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        },
                        {
                            label: state.nomes[0],
                            data: dados.pessoa1,
                            borderColor: 'rgb(249, 115, 22)', /* orange-600 */
                            backgroundColor: 'rgba(249, 115, 22, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: state.nomes[1],
                            data: dados.pessoa2,
                            borderColor: 'rgb(124, 58, 237)', /* violet-600 */
                            backgroundColor: 'rgba(124, 58, 237, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: { size: 12, weight: 'bold' }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return (context.dataset.label || '') + ': R$ ' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toFixed(0);
                                }
                            },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function criarGraficoCategoria() {
            const canvas = document.getElementById('graficoCategoria');
            if (!canvas) return;

            if (state.charts.categoria) {
                state.charts.categoria.destroy();
            }

            const dados = processarDadosCategoria(state.selectedCategory, state.selectedYear);
            const ctx = canvas.getContext('2d');
            
            state.charts.categoria = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dados.labels,
                    datasets: [{
                        label: state.selectedCategory,
                        data: dados.valores,
                        borderColor: 'rgb(16, 185, 129)', /* emerald-500 */
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: 'rgb(16, 185, 129)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: { size: 12, weight: 'bold' }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'R$ ' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toFixed(0);
                                }
                            },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function updateSelectedYear(ano) {
            state.selectedYear = parseInt(ano);
            criarGraficoMensal();
            criarGraficoCategoria();
        }

        function updateSelectedCategory(categoria) {
            state.selectedCategory = categoria;
            criarGraficoCategoria();
        }

        function renderLogin() {
            return `
                <div class="min-h-screen flex items-center justify-center bg-gray-900 px-4 py-8 relative overflow-hidden">
                    
                    <div class="absolute inset-0 overflow-hidden opacity-10">
                        <div class="absolute inset-0 bg-[length:100px_100px] bg-repeat" style="background-image: radial-gradient(#2d3748 1px, transparent 1px);"></div>
                        <div class="absolute inset-0 bg-gradient-to-br from-gray-900 via-gray-900 to-blue-900 opacity-80 mix-blend-multiply"></div>
                    </div>
                    
                    <div class="relative z-10 w-full max-w-md fade-in">
                        <div class="bg-white rounded-xl shadow-2xl overflow-hidden transform transition-all hover:scale-[1.01]">
                            <div class="bg-gray-800 p-8 text-center relative">
                                <div class="relative z-10">
                                    <div class="inline-block mb-4 p-4 rounded-full bg-blue-600 shadow-xl">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8c-.682 0-1.392-.204-2.049-.699m1.34 7.641c.682 0 1.392.204 2.049.699m-6.398 0c1.071 0 2.042.083 2.99.213" /><path stroke-linecap="round" stroke-linejoin="round" d="M14 12H10"/></svg>
                                    </div>
                                    <h1 class="text-3xl font-extrabold text-white mb-2">Acesso ao Painel</h1>
                                    <p class="text-gray-300 text-sm">Controle Or√ßament√°rio Familiar - V2.0</p>
                                </div>
                            </div>
                            
                            <div class="p-8">
                                ${!isFirebaseInitialized ? `
                                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg mb-6">
                                        <div class="flex items-start">
                                            <div class="text-2xl mr-3 text-yellow-500">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.39 16c-.77 1.333.192 3 1.732 3z"/></svg>
                                            </div>
                                            <div>
                                                <p class="font-bold text-yellow-800">Firebase n√£o configurado</p>
                                                <p class="text-sm text-yellow-700 mt-1">Configure o Firebase no c√≥digo para usar o sistema.</p>
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}

                                <div class="mb-6">
                                    <label class="block text-sm font-bold text-gray-700 mb-2">üîë Senha de Acesso</label>
                                    <div class="relative">
                                        <input
                                            type="password"
                                            value="${state.loginPassword}"
                                            onchange="state.loginPassword = this.value; state.loginError = ''; render();"
                                            onkeypress="if(event.key === 'Enter') handleLogin()"
                                            placeholder="M√≠nimo de 6 caracteres"
                                            class="w-full px-5 py-3 pr-12 border-2 border-gray-300 rounded-lg transition-all duration-150"
                                            autofocus
                                        />
                                        <div class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v3h8z"/></svg>
                                        </div>
                                    </div>
                                </div>

                                ${state.loginError ? `
                                    <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg mb-6 fade-in">
                                        <div class="flex items-center">
                                            <div class="text-xl mr-3 text-red-600">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                            </div>
                                            <p class="text-red-700 font-medium">${state.loginError}</p>
                                        </div>
                                    </div>
                                ` : ''}

                                <button
                                    onclick="handleLogin()"
                                    class="w-full bg-blue-600 text-white py-4 rounded-lg font-bold text-lg hover:bg-blue-700 shadow-lg transform hover:scale-[1.005] transition-all duration-200 flex items-center justify-center gap-2"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/></svg>
                                    Acessar Painel
                                </button>

                                <div class="mt-8 bg-blue-50 rounded-xl p-5 border-2 border-blue-200">
                                    <div class="flex items-start">
                                        <div class="text-2xl mr-3 mt-1 text-blue-500">üí°</div>
                                        <div>
                                            <p class="font-bold text-blue-900 mb-2">Primeira vez aqui?</p>
                                            <p class="text-sm text-blue-800 mb-2">Use a senha padr√£o:</p>
                                            <div class="bg-white px-4 py-2 rounded-lg inline-block border-2 border-blue-200">
                                                <code class="text-blue-600 font-bold text-lg">familia2024</code>
                                            </div>
                                            <p class="text-xs text-blue-600 mt-3">üí° Voc√™ pode alter√°-la depois nas configura√ß√µes</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-6 text-gray-400 text-sm">
                            <p>üîí Sistema de Controle Financeiro V2.0</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            const totals = getTotals();
            return `
                <div class="space-y-8">
                    <div class="flex justify-end">
                        <button onclick="exportToExcel()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-all flex items-center gap-2 font-semibold shadow-md hover:shadow-xl transform hover:scale-[1.01]">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                            Exportar Dados
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white rounded-xl shadow-xl border-l-4 border-blue-600 p-6">
                            <div class="flex items-center justify-between">
                                <p class="text-sm font-semibold text-blue-600 uppercase">Total Geral</p>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8c-.682 0-1.392-.204-2.049-.699m1.34 7.641c.682 0 1.392.204 2.049.699m-6.398 0c1.071 0 2.042.083 2.99.213" /></svg>
                            </div>
                            <p class="text-4xl font-extrabold text-gray-900 mt-2">R$ ${totals.totalGeral.toFixed(2)}</p>
                            <p class="text-xs text-gray-500 mt-1">Soma de fixos e vari√°veis</p>
                        </div>
                        <div class="bg-white rounded-xl shadow-xl border-l-4 border-green-600 p-6">
                            <div class="flex items-center justify-between">
                                <p class="text-sm font-semibold text-green-600 uppercase">Gastos Fixos</p>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 14h.01M12 6V4m0 0V3m0 1h2m-2 0H10m-3 3H5m0 0v14a2 2 0 002 2h10a2 2 0 002-2V7H7z"/></svg>
                            </div>
                            <p class="text-4xl font-extrabold text-gray-900 mt-2">R$ ${totals.totalFixos.toFixed(2)}</p>
                            <p class="text-xs text-gray-500 mt-1">Despesas recorrentes</p>
                        </div>
                        <div class="bg-white rounded-xl shadow-xl border-l-4 border-purple-600 p-6">
                            <div class="flex items-center justify-between">
                                <p class="text-sm font-semibold text-purple-600 uppercase">Gastos Vari√°veis</p>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 7h10m0 0v10m0-10L7 17M7 7l10 10m-3-4a8 8 0 100-16 8 8 0 000 16z"/></svg>
                            </div>
                            <p class="text-4xl font-extrabold text-gray-900 mt-2">R$ ${totals.totalVariaveis.toFixed(2)}</p>
                            <p class="text-xs text-gray-500 mt-1">Despesas n√£o recorrentes</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-4 border-b pb-4">
                            <h2 class="text-2xl font-bold text-gray-800">Responsabilidade Financeira</h2>
                            <button onclick="openEditNames()" class="text-sm font-medium text-blue-600 hover:text-blue-700 flex items-center gap-1 p-2 rounded-lg hover:bg-blue-50 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                                Editar Nomes
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            ${state.nomes.map(nome => {
                                const total = calcularTotalPorPessoa(nome);
                                const quantidade = state.gastos.filter(g => g.responsavel === nome).length;
                                const color = nome === state.nomes[0] ? 'indigo' : 'pink';
                                return `
                                    <div class="bg-white rounded-lg p-5 border-2 border-gray-200 shadow-sm hover:shadow-lg transition-shadow">
                                        <p class="text-base text-gray-700 font-semibold flex items-center gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-${color}-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                                            ${nome}
                                        </p>
                                        <p class="text-3xl font-bold text-gray-900 mt-2">R$ ${total.toFixed(2)}</p>
                                        <p class="text-xs text-gray-500 mt-1">${quantidade} despesa${quantidade !== 1 ? 's' : ''} registradas</p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-4">Despesas Fixas</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${state.categoriasFixas.map(cat => {
                                const total = calcularTotalCategoria(cat, 'fixo');
                                return `
                                    <div class="bg-green-50 rounded-lg p-4 border border-green-200 hover:bg-green-100 transition-colors">
                                        <p class="text-sm text-green-700 font-semibold flex items-center gap-1">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                                            ${cat}
                                        </p>
                                        <p class="text-2xl font-bold text-green-800 mt-1">R$ ${total.toFixed(2)}</p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-4">Despesas Vari√°veis (Metas)</h2>
                        <div class="space-y-6">
                            ${state.categoriasVariaveis.map(cat => {
                                const total = calcularTotalCategoria(cat, 'variavel');
                                const limite = state.limites[cat] || 0;
                                const status = verificarLimite(cat, total);
                                const percentual = limite > 0 ? (total / limite) * 100 : 0;
                                
                                return `
                                    <div class="bg-white rounded-lg p-5 border-2 border-purple-200 shadow-md hover:border-purple-300 transition-all">
                                        <div class="flex justify-between items-start mb-3">
                                            <div class="flex-1">
                                                <p class="text-lg text-purple-700 font-bold">${cat}</p>
                                                <p class="text-3xl font-extrabold text-gray-800 mt-1">R$ ${total.toFixed(2)}</p>
                                            </div>
                                            <div class="text-right">
                                                <label class="block text-xs font-medium text-gray-500 mb-1">Definir Meta (R$)</label>
                                                <input type="number" step="0.01" placeholder="0.00" value="${limite || ''}" onchange="handleSetLimite('${cat}', this.value)" class="w-28 px-3 py-1 border-2 border-gray-300 rounded-lg text-sm transition-all duration-150"/>
                                            </div>
                                        </div>
                                        ${limite > 0 ? `
                                            <div class="mt-3 pt-3 border-t border-gray-100">
                                                <div class="flex justify-between text-xs text-gray-600 mb-2 font-medium">
                                                    <span class="p-1 rounded-full ${percentual >= 100 ? 'bg-red-100 text-red-700' : percentual >= 80 ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'}">${percentual.toFixed(0)}% usado</span>
                                                    <span class="font-bold text-gray-700">Meta: R$ ${limite.toFixed(2)}</span>
                                                </div>
                                                <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                                                    <div 
                                                        class="h-full rounded-full transition-all duration-500 ease-in-out ${status === 'danger' ? 'bg-red-500' : status === 'warning' ? 'bg-yellow-500' : 'bg-green-500'}" 
                                                        style="width: ${Math.min(percentual, 100)}%"
                                                    ></div>
                                                </div>
                                                ${status === 'danger' ? '<div class="flex items-center gap-1 mt-2 text-red-600 text-sm font-semibold"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.39 16c-.77 1.333.192 3 1.732 3z"/></svg> Limite Or√ßament√°rio Atingido!</div>' : ''}
                                                ${status === 'warning' ? '<div class="flex items-center gap-1 mt-2 text-yellow-600 text-sm font-semibold"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.39 16c-.77 1.333.192 3 1.732 3z"/></svg> Aten√ß√£o: Pr√≥ximo do Limite</div>' : ''}
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAddGasto() {
            return `
                <div class="bg-white rounded-xl shadow-lg p-8 max-w-2xl mx-auto">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-4">‚ûï Registrar Nova Despesa</h2>
                    <div class="space-y-5">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Respons√°vel</label>
                                <select onchange="updateFormData('responsavel', this.value)" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg transition-all duration-150">
                                    ${state.nomes.map(nome => `<option value="${nome}" ${state.formData.responsavel === nome ? 'selected' : ''}>${nome}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Tipo de Gasto</label>
                                <select onchange="updateFormData('tipo', this.value); updateFormData('categoria', '')" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg transition-all duration-150">
                                    <option value="fixo" ${state.formData.tipo === 'fixo' ? 'selected' : ''}>Fixo (Recorrente)</option>
                                    <option value="variavel" ${state.formData.tipo === 'variavel' ? 'selected' : ''}>Vari√°vel (Pontual)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Categoria</label>
                            <select onchange="updateFormData('categoria', this.value)" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg transition-all duration-150">
                                <option value="">Selecione uma categoria</option>
                                ${(state.formData.tipo === 'fixo' ? state.categoriasFixas : state.categoriasVariaveis).map(cat => `
                                    <option value="${cat}" ${state.formData.categoria === cat ? 'selected' : ''}>${cat}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Valor (R$)</label>
                                <input type="number" step="0.01" value="${state.formData.valor}" onchange="updateFormData('valor', this.value)" placeholder="0.00" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg transition-all duration-150"/>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Data</label>
                                <input type="date" value="${state.formData.data}" onchange="updateFormData('data', this.value)" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg transition-all duration-150"/>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Descri√ß√£o (Opcional)</label>
                            <textarea onchange="updateFormData('descricao', this.value)" placeholder="Descreva o gasto (Ex: Supermercado do m√™s, presente de anivers√°rio)" rows="3" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg transition-all duration-150">${state.formData.descricao}</textarea>
                        </div>
                        
                        <button onclick="handleAddGasto()" class="w-full bg-blue-600 text-white py-4 rounded-lg font-bold text-lg hover:bg-blue-700 shadow-xl transform hover:scale-[1.005] transition-all flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            Adicionar Gasto
                        </button>
                    </div>
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <button onclick="openAddCategory()" class="text-blue-600 hover:text-blue-700 font-semibold text-sm flex items-center gap-1 p-2 rounded-lg hover:bg-blue-50 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                            Adicionar Nova Categoria
                        </button>
                    </div>
                </div>
            `;
        }

        function renderGraficos() {
            const anos = getAnosDisponiveis();
            const todasCategorias = [...state.categoriasFixas, ...state.categoriasVariaveis];
            
            if (state.gastos.length === 0) {
                return `
                    <div class="bg-white rounded-xl shadow-lg p-10 text-center">
                        <div class="text-6xl mb-4 text-blue-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M7 12l3-3 3 3 4-4M5 12h14M7 16h10"/></svg>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Nenhum dado para visualizar</h2>
                        <p class="text-gray-600">Adicione seus primeiros gastos na aba "Adicionar" para gerar os gr√°ficos.</p>
                    </div>
                `;
            }

            return `
                <div class="space-y-8">
                    <div class="bg-white rounded-xl shadow-lg p-5 flex items-center gap-4 border-l-4 border-gray-200">
                        <label class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-4 10h4m-4 4h4M3 21h18a2 2 0 002-2V7a2 2 0 00-2-2H3a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                            An√°lise Temporal:
                        </label>
                        <select onchange="updateSelectedYear(this.value)" class="px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium transition-all duration-150">
                            ${anos.map(ano => `<option value="${ano}" ${ano === state.selectedYear ? 'selected' : ''}>${ano}</option>`).join('')}
                        </select>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                            Evolu√ß√£o Mensal de Gastos (${state.selectedYear})
                        </h2>
                        <p class="text-sm text-gray-600 mb-6">Acompanhe os gastos totais e por respons√°vel ao longo do ano.</p>
                        <div style="height: 450px;"><canvas id="graficoMensal"></canvas></div>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6 border-b pb-4">
                            <div>
                                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 8v.01M6 6h12a2 2 0 012 2v8a2 2 0 01-2 2H6a2 2 0 01-2-2V8a2 2 0 012-2z"/></svg>
                                    An√°lise Detalhada por Categoria
                                </h2>
                                <p class="text-sm text-gray-600">Selecione uma categoria para ver a evolu√ß√£o mensal.</p>
                            </div>
                            <select onchange="updateSelectedCategory(this.value)" class="px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 font-medium transition-all duration-150">
                                ${todasCategorias.map(cat => `<option value="${cat}" ${cat === state.selectedCategory ? 'selected' : ''}>${cat}</option>`).join('')}
                            </select>
                        </div>
                        <div style="height: 450px;"><canvas id="graficoCategoria"></canvas></div>
                    </div>

                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl shadow-inner p-6 border border-blue-200">
                        <h3 class="text-xl font-bold text-gray-800 mb-5">Sum√°rio Financeiro de ${state.selectedYear}</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            ${(() => {
                                const gastosAno = state.gastos.filter(g => new Date(g.data + 'T00:00:00').getFullYear() === state.selectedYear);
                                const totalAno = gastosAno.reduce((sum, g) => sum + g.valor, 0);
                                const mediaMensal = totalAno / 12;
                                const maiorGasto = Math.max(...gastosAno.map(g => g.valor), 0);
                                const quantidadeGastos = gastosAno.length;
                                
                                return `
                                    <div class="bg-white rounded-lg p-4 text-center shadow-sm">
                                        <p class="text-sm text-gray-500 mb-1">Total Consolidado</p>
                                        <p class="text-xl font-bold text-blue-600">R$ ${totalAno.toFixed(2)}</p>
                                    </div>
                                    <div class="bg-white rounded-lg p-4 text-center shadow-sm">
                                        <p class="text-sm text-gray-500 mb-1">M√©dia Mensal (Est.)</p>
                                        <p class="text-xl font-bold text-green-600">R$ ${mediaMensal.toFixed(2)}</p>
                                    </div>
                                    <div class="bg-white rounded-lg p-4 text-center shadow-sm">
                                        <p class="text-sm text-gray-500 mb-1">Maior Transa√ß√£o</p>
                                        <p class="text-xl font-bold text-orange-600">R$ ${maiorGasto.toFixed(2)}</p>
                                    </div>
                                    <div class="bg-white rounded-lg p-4 text-center shadow-sm">
                                        <p class="text-sm text-gray-500 mb-1">Qtd. de Registros</p>
                                        <p class="text-xl font-bold text-purple-600">${quantidadeGastos}</p>
                                    </div>
                                `;
                            })()}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderHistorico() {
            const sortedGastos = [...state.gastos].sort((a, b) => new Date(b.data) - new Date(a.data));
            
            return `
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6 border-b pb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Hist√≥rico de Transa√ß√µes</h2>
                        <button onclick="exportToExcel()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2 font-semibold shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                            Exportar Excel
                        </button>
                    </div>

                    <div class="hidden md:grid grid-cols-5 gap-3 p-3 text-sm font-semibold text-gray-500 border-b border-gray-200">
                        <span class="md:col-span-2">Categoria / Descri√ß√£o</span>
                        <span class="text-center">Respons√°vel</span>
                        <span class="text-right">Valor</span>
                        <span class="text-right">Data / A√ß√µes</span>
                    </div>

                    ${sortedGastos.length === 0 ? `
                        <p class="text-center text-gray-500 py-8">Nenhuma despesa registrada ainda.</p>
                    ` : `
                        <div class="space-y-3 mt-4">
                            ${sortedGastos.map(gasto => `
                                <div class="grid grid-cols-1 md:grid-cols-5 gap-3 p-4 bg-white rounded-lg border-l-4 border-gray-300 shadow-sm hover:shadow-md hover:border-blue-400 transition-all">
                                    <div class="md:col-span-2">
                                        <div class="flex items-center gap-3 flex-wrap mb-1">
                                            <span class="text-lg font-bold text-gray-900">${gasto.categoria}</span>
                                            <span class="px-2 py-0.5 rounded-full text-xs font-semibold ${gasto.tipo === 'fixo' ? 'bg-green-100 text-green-700' : 'bg-indigo-100 text-indigo-700'}">
                                                ${gasto.tipo === 'fixo' ? 'FIXO' : 'VARI√ÅVEL'}
                                            </span>
                                        </div>
                                        <p class="text-sm text-gray-500">${gasto.descricao || 'Sem descri√ß√£o'}</p>
                                    </div>
                                    <div class="flex items-center md:justify-center">
                                        <span class="text-sm font-medium text-gray-700 flex items-center gap-1">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                                            ${gasto.responsavel}
                                        </span>
                                    </div>
                                    <div class="flex items-center md:justify-end">
                                        <span class="text-xl font-extrabold text-red-600">R$ ${gasto.valor.toFixed(2)}</span>
                                    </div>
                                    <div class="flex items-center md:justify-end gap-3">
                                        <span class="text-xs text-gray-500">${new Date(gasto.data + 'T00:00:00').toLocaleDateString('pt-BR')}</span>
                                        <button onclick="handleRemoveGasto(${gasto.id})" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-50 transition-colors" title="Excluir Gasto">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        function renderConfig() {
            return `
                <div class="bg-white rounded-xl shadow-lg p-8 max-w-2xl mx-auto">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-4">‚öôÔ∏è Configura√ß√µes do Sistema</h2>
                    <div class="space-y-8">
                        
                        <div class="border-b border-gray-200 pb-6">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 7h3a5 5 0 015 5v2m-4 1v2m-6-4v2m-6-2v2m-3-1V7a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2z"/></svg>
                                Seguran√ßa
                            </h3>
                            ${!state.showChangePassword ? `
                                <button onclick="state.showChangePassword = true; render();" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors shadow-md">
                                    Alterar Senha de Acesso
                                </button>
                            ` : `
                                <div class="space-y-4 bg-gray-50 p-5 rounded-lg border border-blue-100 fade-in">
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">Nova Senha</label>
                                        <input type="password" value="${state.newPassword}" onchange="state.newPassword = this.value; render();" placeholder="M√≠nimo 6 caracteres" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg transition-all duration-150"/>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">Confirmar Nova Senha</label>
                                        <input type="password" value="${state.confirmPassword}" onchange="state.confirmPassword = this.value; render();" placeholder="Digite novamente" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg transition-all duration-150"/>
                                    </div>
                                    ${state.passwordError ? `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded text-sm">${state.passwordError}</div>` : ''}
                                    <div class="flex gap-3 pt-2">
                                        <button onclick="state.showChangePassword = false; state.newPassword = ''; state.confirmPassword = ''; state.passwordError = ''; render();" class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100">Cancelar</button>
                                        <button onclick="handleChangePassword()" class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-md">Salvar Nova Senha</button>
                                    </div>
                                </div>
                            `}
                        </div>
                        
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                                Gerenciamento de Sess√£o
                            </h3>
                            <button onclick="handleLogout()" class="bg-red-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-700 transition-colors shadow-md">
                                Sair do Sistema
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateFormData(field, value) {
            state.formData[field] = value;
            render();
        }

        function openAddCategory() {
            state.showAddCategory = true;
            render();
        }

        function openEditNames() {
            state.tempNome1 = state.nomes[0];
            state.tempNome2 = state.nomes[1];
            state.showEditNames = true;
            render();
        }

        function render() {
            if (!state.isAuthenticated) {
                document.getElementById('root').innerHTML = renderLogin();
                return;
            }

            const content = `
                <div class="container mx-auto px-4 py-10">
                    <div class="text-center mb-10">
                        <h1 class="text-4xl font-extrabold text-gray-900 mb-2">üí∏ Family Budget Manager</h1>
                        <p class="text-gray-600 text-lg">Gerencie suas finan√ßas de forma simples e eficiente</p>
                    </div>
                    
                    <div class="flex justify-center mb-10">
                        <div class="bg-white border border-gray-200 rounded-full shadow-lg p-1 inline-flex gap-1 flex-wrap">
                            <button onclick="changeTab('dashboard')" class="flex items-center gap-2 px-5 py-2 rounded-full font-semibold transition-all duration-300 ${state.activeTab === 'dashboard' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-700 hover:bg-gray-50'}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg>
                                Dashboard
                            </button>
                            <button onclick="changeTab('adicionar')" class="flex items-center gap-2 px-5 py-2 rounded-full font-semibold transition-all duration-300 ${state.activeTab === 'adicionar' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-700 hover:bg-gray-50'}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                Adicionar
                            </button>
                            <button onclick="changeTab('graficos')" class="flex items-center gap-2 px-5 py-2 rounded-full font-semibold transition-all duration-300 ${state.activeTab === 'graficos' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-700 hover:bg-gray-50'}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"/><path stroke-linecap="round" stroke-linejoin="round" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"/></svg>
                                Gr√°ficos
                            </button>
                            <button onclick="changeTab('historico')" class="flex items-center gap-2 px-5 py-2 rounded-full font-semibold transition-all duration-300 ${state.activeTab === 'historico' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-700 hover:bg-gray-50'}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                                Hist√≥rico
                            </button>
                            <button onclick="changeTab('config')" class="flex items-center gap-2 px-5 py-2 rounded-full font-semibold transition-all duration-300 ${state.activeTab === 'config' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-700 hover:bg-gray-50'}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="max-w-7xl mx-auto">
                        <div class="fade-in">
                            ${state.activeTab === 'dashboard' ? renderDashboard() : ''}
                            ${state.activeTab === 'adicionar' ? renderAddGasto() : ''}
                            ${state.activeTab === 'graficos' ? renderGraficos() : ''}
                            ${state.activeTab === 'historico' ? renderHistorico() : ''}
                            ${state.activeTab === 'config' ? renderConfig() : ''}
                        </div>
                    </div>
                </div>

                ${state.showAddCategory ? `
                    <div class="fixed inset-0 bg-gray-900 bg-opacity-70 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                        <div class="bg-white rounded-xl p-8 max-w-md w-full shadow-2xl fade-in">
                            <h3 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3">Nova Categoria</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Tipo</label>
                                    <select onchange="state.categoryType = this.value; render();" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg transition-all duration-150">
                                        <option value="fixo" ${state.categoryType === 'fixo' ? 'selected' : ''}>Fixo (Recorrente)</option>
                                        <option value="variavel" ${state.categoryType === 'variavel' ? 'selected' : ''}>Vari√°vel (Pontual)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Nome da Categoria</label>
                                    <input type="text" value="${state.newCategoryName}" onchange="state.newCategoryName = this.value" placeholder="Ex: Aluguel, Transporte" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg transition-all duration-150"/>
                                </div>
                                <div class="flex gap-3 pt-4">
                                    <button onclick="state.showAddCategory = false; state.newCategoryName = ''; render();" class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-100">Cancelar</button>
                                    <button onclick="handleAddCategory()" class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-md">Adicionar Categoria</button>
                                </div>
                            </div>
                        </div>
                    </div>
                ` : ''}

                ${state.showEditNames ? `
                    <div class="fixed inset-0 bg-gray-900 bg-opacity-70 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                        <div class="bg-white rounded-xl p-8 max-w-md w-full shadow-2xl fade-in">
                            <h3 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3">Personalizar Nomes</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Pessoa 1</label>
                                    <input type="text" value="${state.tempNome1}" onchange="state.tempNome1 = this.value" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg transition-all duration-150"/>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Pessoa 2</label>
                                    <input type="text" value="${state.tempNome2}" onchange="state.tempNome2 = this.value" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg transition-all duration-150"/>
                                </div>
                                <div class="flex gap-3 pt-4">
                                    <button onclick="state.showEditNames = false; render();" class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-100">Cancelar</button>
                                    <button onclick="handleSaveNames()" class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-md">Salvar Nomes</button>
                                </div>
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
            
            document.getElementById('root').innerHTML = content;
        }

        function changeTab(tab) {
            state.activeTab = tab;
            render();
            
            if (tab === 'graficos') {
                setTimeout(() => {
                    if (!state.selectedYear) {
                        const anos = getAnosDisponiveis();
                        state.selectedYear = anos.length > 0 ? anos[0] : new Date().getFullYear();
                    }
                    
                    if (!state.selectedCategory) {
                        const todasCategorias = [...state.categoriasFixas, ...state.categoriasVariaveis];
                        state.selectedCategory = todasCategorias[0] || 'Escola';
                    }
                    
                    criarGraficoMensal();
                    criarGraficoCategoria();
                }, 100);
            }
        }

        if (isFirebaseInitialized) {
            checkStoredPassword();
        }
        render();
    </script>
</body>
</html>
